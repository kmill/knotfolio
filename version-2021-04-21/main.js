"use strict";function t(t){if(!t)throw new Error("assertion failed")}function e(t,e){let r=t.indexOf(e);return r>=0&&(t.splice(r,1),!0)}function r(t,e){if("object"==typeof t&&"object"==typeof e){if(t.equal)return t.equal(e);if(t instanceof Array){if(!(e instanceof Array)||t.constructor!==e.constructor)return!1;if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!r(t[i],e[i]))return!1;return!0}}return t===e}function i(e,r){if(t(typeof e==typeof r),"object"==typeof e){if(e.compare)return e.compare(r);if(e instanceof Array){if(t(r instanceof Array),t(e.constructor===r.constructor),e.length!==r.length)return e.length-r.length;for(let t=0;t<e.length;t++){let n=i(e[t],r[t]);if(0!==n)return n}return 0}throw new TypeError}if("number"==typeof e||"boolean"==typeof e)return e-r;if("string"==typeof e)return e.localeCompare(r);if("null"==typeof e||void 0===e)return 0;throw new Error("Unexpected type "+typeof e)}function n(t){switch(t){case"\0":return"\\0";case'"':return'\\"';case"\\":return"\\\\";case"\n":return"\\n";case"\r":return"\\r";case"\v":return"\\v";case"\t":return"\\t";case"\b":return"\\b";case"\f":return"\\f"}var e=t.charCodeAt(0);return 32<=e&&e<127?t:e<256?"\\x"+(e<16?"0":"")+e.toString(16).toUpperCase():"\\u"+(e<4096?"0":"")+e.toString(16).toUpperCase()}function s(t){if(t instanceof Array&&t.toString===Array.prototype.toString)return"["+t.map(s).join(", ")+"]";if("object"==typeof t)return t.toString();if("string"==typeof t){let e="'";for(let r=0;r<t.length;r++)e+=n(t.charAt(r));return e+"'"}return""+t}class o extends Array{constructor(){if(1===arguments.length)super(arguments[0]);else{super(arguments.length);for(let t=0;t<arguments.length;t++)this[t]=arguments[t]}}equal(e){if(t(e.constructor===this.constructor),this.length!==e.length)return!1;for(let t=0;t<this.length;t++)if(!r(this[t],e[t]))return!1;return!0}compare(e){if(t(e.constructor===this.constructor),this.length!==e.length)return this.length-e.length;for(let t=0;t<this.length;t++){let r=i(this[t],e[t]);if(0!==r)return r}return 0}toString(){return this.constructor.name+".make("+this.map(s).join(", ")+")"}static make(){let t=new this(arguments.length);for(let e=0;e<arguments.length;e++)t[e]=arguments[e];return t}}function a(t,e,r){return Math.max(e,Math.min(r,t))}function l(t){let e=255&t,r=255&(t>>>=8);function i(t){return t<16?"0"+t.toString(16):t.toString(16)}return"#"+i(255&(t>>>=8))+i(r)+i(e)}function h(e,r){for(t(e===(0|e)),t(r===(0|r)),(e=Math.abs(e))<(r=Math.abs(r))&&([e,r]=[r,e]);0!==r;)[e,r]=[r,e%r];return e}function c(t){if(t instanceof c)return t;if("string"==typeof t)return c.query(t);if(!this||this===window)return new c(t);if(0===arguments.length)this.length=0;else if(null===t)this.length=0;else if(t instanceof Element||t===window)this[0]=t,this.length=1;else if(t instanceof NodeList){this.length=t.length;for(let e=0;e<t.length;e++)this[e]=t[e]}else if(t instanceof Array){this.length=0;for(let e=0;e<t.length;e++)if(t[e]instanceof c)for(let r=0;r<t[e].length;r++)this[this.length++]=t[e][r];else this[this.length++]=t[e]}else{if("function"!=typeof t)throw new Error("Invalid argument to Q");this[0]=window,this.length=1,this.on("load",t)}}function f(t){c[t]=function(){return c.create(t,...arguments)}}c.create=function(t,e){let r=new c(document.createElement(t)),i=1;if("object"==typeof e&&!(e instanceof c)&&(i++,e))for(let t in e)r[0][t]=e[t];for(;i<arguments.length;i++)r.append(arguments[i]);return r},c.textNode=function(t){return new c(document.createTextNode(t))},c.withId=function(t){return new c(document.getElementById(t))},c.query=function(t){return new c(document.querySelectorAll(t))},c.prototype.query=function(t){for(var e=new c,r=0,i=0;i<this.length;i++)this[i].querySelectorAll(t).forEach((t=>{e[r++]=t}));return e.length=r,e},c.prototype.forEach=function(t){for(var e=0;e<this.length;e++)t(new c(this[e]),e)},c.prototype.append=function(){for(let t=0;t<arguments.length;t++){let e=arguments[t];e instanceof c?e.appendTo(this):e instanceof Element?this[0].appendChild(e):this[0].appendChild(document.createTextNode(""+e))}return this},c.prototype.appendTo=function(t){t instanceof c&&(t=t[0]);for(var e=0;e<this.length;e++)t.appendChild(this[e]);return this},c.prototype.remove=function(){for(var t=0;t<this.length;t++)null!==this[t].parentNode&&this[t].parentNode.removeChild(this[t]);return this},c.prototype.addClass=function(t){for(var e=0;e<this.length;e++)this[e].classList.add(t);return this},c.prototype.removeClass=function(t){for(var e=0;e<this.length;e++)this[e].classList.remove(t);return this},c.prototype.toggleClass=function(t,e){for(var r=0;r<this.length;r++)arguments.length>=2?this[r].classList.toggle(t,e):this[r].classList.toggle(t);return this},c.prototype.on=function(t,e,r){for(var i=t.split(" "),n=0;n<i.length;n++)if(""!==i[n])for(var s=0;s<this.length;s++)this[s].addEventListener(i[n],e,!!r);return this},c.prototype.off=function(t,e){for(var r=t.split(" "),i=0;i<r.length;i++)if(""!==r[i])for(var n=0;n<this.length;n++)this[n].removeEventListener(r[i],e);return this},c.prototype.empty=function(){for(var t=0;t<this.length;t++)for(var e=this[t];e.firstChild;)e.removeChild(e.firstChild);return this},c.prototype.attr=function(t,e){if(1===arguments.length)return this[0].getAttribute(t);for(var r=0;r<this.length;r++)this[r].setAttribute(t,e);return this},c.prototype.prop=function(t,e){if(1===arguments.length)return this[0][t];for(var r=0;r<this.length;r++)this[r][t]=e;return this},c.prototype.value=function(t){if(0===arguments.length)return this[0].value;for(var e=0;e<this.length;e++)this[e].value=t;return this},c.prototype.css=function(t,e){if(1===arguments.length)return this[0].style[t];for(var r=0;r<this.length;r++)this[r].style[t]=e;return this},f("div"),f("span"),f("p"),f("ol"),f("ul"),f("li"),f("sup"),f("a");class p extends o{copy(){return this.slice()}normalize(){for(;this.length>0&&0===this[this.length-1];)this.pop();return this}degree(){return this.normalize(),this.length-1}is_zero(){return 0===this.length}is_unit(){return 1===this.length&&1===this[0]}leading_coeff(){return 0===this.length?0:this[this.length-1]}is_monic(t=!1){if(this.length>0){let e=this[this.length-1];return t&&(e=Math.abs(e)),1===e}return!1}min_exp(){if(0===this.length)return 1/0;for(let t=0;t<this.length;t++)if(0!==this[t])return t;return t(!1)}mul_x(e){if(0===this.length)return p.zero;if(e>=0){let t=this.slice();for(let r=0;r<e;r++)t.unshift(0);return t}{let r=this.slice();e=-e;for(let i=0;i<e;i++){t(0===r.shift())}return r}}add(e){t(e instanceof p);let r=this;r.length<e.length&&([r,e]=[e,r]);let i=r.slice();for(let t=0;t<e.length;t++)i[t]+=e[t];return i.normalize()}mul(e){t(e instanceof p);let r=this;if(0===r.length||0===e.length)return p.zero;let i=new p(r.length+e.length-1);i.fill(0);for(let t=0;t<r.length;t++)for(let n=0;n<e.length;n++)i[t+n]+=r[t]*e[n];return i}scale(e){return t("number"==typeof e),0===e?p.zero:this.map((t=>t*e))}content(){return this.reduce(((t,e)=>h(t,e)),0)}z_divisible(e){return t("number"==typeof e&&0!==e),this.every((t=>t%e==0))}gcd(e){t(e instanceof p);let r=this.slice(),i=e.slice();r.forEach((e=>t(e===(0|e)))),i.forEach((e=>t(e===(0|e))));let n=h(r.content(),i.content()),s=1,o=1;function a(){if(r.normalize(),0===r.length)s=1;else{let t=r.content();t*=Math.sign(r[r.length-1]);for(let e=0;e<r.length;e++)r[e]/=t;s=r[r.length-1]}if(i.normalize(),0===i.length)o=1;else{let t=i.content();t*=Math.sign(i[i.length-1]);for(let e=0;e<i.length;e++)i[e]/=t;o=i[i.length-1]}r.length<i.length&&([r,s,i,o]=[i,o,r,s]);let t=h(s,o);s/=t,o/=t}for(a();i.length>0;){for(let t=0;t<r.length;t++)r[t]*=o;let t=r.length-i.length;for(let e=0;e<i.length;e++)r[e+t]-=s*i[e];a()}for(let t=0;t<r.length;t++)r[t]=r[t]*n;return r}divide(e){if(t(e instanceof p),t(e.degree()>=0),0===e.degree())return this.map((t=>t/e[0]));let r=e.leading_coeff(),i=this,n=p.zero;for(;;){let t=i.degree()-e.degree();if(t<0)break;let s=i.leading_coeff()/r;n=n.add(p.incl(s).mul_x(t)),i=i.add(e.scale(-s).mul_x(t))}return n}static incl(t){return p.make(t)}}p.zero=p.make(),p.unit=p.make(1);class u{constructor(t,e){this.coeff=t,this.exp=e}equal(e){return t(e instanceof u),this.coeff===e.coeff&&this.exp===e.exp}static make(e,r){return t(2===arguments.length),new this(e,r)}toString(){return"LTerm.make("+this.coeff+", "+this.exp+")"}}class d extends o{copy(){return this.slice()}is_zero(){return 0===this.length}normalize(){this.sort(((t,e)=>t.exp-e.exp));let t=0;for(;t<this.length;){let e=this[t],r=e.coeff,i=t+1;for(;i<this.length&&this[i].exp===e.exp;)r+=this[i].coeff,i++;0===r?this.splice(t,i-t):i>t+1?(this[t]=u.make(r,e.exp),i-t-1>0&&this.splice(t+1,i-t-1),t++):t++}return this}toListString(){if(this.normalize(),0===this.length)return"[0; 0]";let t=this[0].exp,e=[];this.forEach((r=>{e[r.exp-t]=r.coeff}));for(let t=0;t<e.length;t++)void 0===e[t]&&(e[t]=0);return"["+t+"; "+e+"]"}toMathematica(t="t",e=1){if(this.normalize(),0===this.length)return"0";let r="";function i(t){return 1===t?"":Math.floor(t)===t?"^"+t:"^("+t*e+"/"+e+")"}for(let n=this.length-1;n>=0;n--){let s=this[n],o=s.exp/e;s.coeff>0?(0!==r.length&&(r+=" + "),1===s.coeff&&0===o?r+="1":(1!==s.coeff&&(r+=s.coeff),0!==o&&(r+=t+i(o)))):-1===s.coeff?(0===r.length?r+="-":r+=" - ",r+=0===o?"1":t+i(o)):(0===r.length?r+=s.coeff:r+=" - "+-s.coeff,0!==o&&(r+=t+i(o)))}return r}toDOM(t="t",e=1){if(this.normalize(),0===this.length)return"0";let r=[];function i(t){function i(t){return t<0?"−"+-t:""+t}1===t||(Math.floor(t)===t?r.push(c.create("sup",i(t))):r.push(c.create("sup",i(t*e)+"/"+e)))}function n(){r.push(c.create("var",t))}for(let t=this.length-1;t>=0;t--){let s=this[t],o=s.exp/e;s.coeff>0?(0!==r.length&&r.push(" + "),1===s.coeff&&0===o?r.push("1"):(1!==s.coeff&&r.push(""+s.coeff),0!==o&&(n(),i(o)))):-1===s.coeff?(0===r.length?r.push("−"):r.push(" − "),0===o?r.push("1"):(n(),i(o))):(0===r.length?r.push(""+s.coeff):r.push(" − "+-s.coeff),0!==o&&(n(),i(o)))}return c.create("span",null,...r)}add(e,r=1,i=0){t(e instanceof d);let n=this,s=d.make(),o=0,a=0;for(;o<n.length&&a<e.length;){let t=n[o],l=e[a];if(t.exp<l.exp+i)s.push(t),o++;else if(t.exp>l.exp+i)s.push(u.make(r*l.coeff,l.exp+i)),a++;else{let e=t.coeff+r*l.coeff;0!==e&&s.push(u.make(e,t.exp)),o++,a++}}for(;o<n.length;o++)s.push(n[o]);for(;a<e.length;a++){let t=e[a];s.push(u.make(r*t.coeff,t.exp+i))}return s}mul(e){t(e instanceof d);let r=d.make();return e.forEach((t=>{r=r.add(this,t.coeff,t.exp)})),r}simple_mul(e=1,r=0){if(t("number"==typeof e&&"number"==typeof r),0===e)return d.zero;let i=d.make();return this.forEach((t=>{i.push(u.make(e*t.coeff,r+t.exp))})),i}negate(){return this.simple_mul(-1)}to_poly(e=!1){if(0===this.length)return p.zero;{let r=this[0].exp;e&&(t(r>=0),r=0);let i=p.make();this.forEach((t=>{i[t.exp-r]=t.coeff}));for(let t=0;t<i.length;t++)void 0===i[t]&&(i[t]=0);return i}}coeffs(){if(0===this.length)return[];{let t=this[0].exp,e=[];this.forEach((r=>{e[r.exp-t]=r.coeff}));for(let t=0;t<e.length;t++)void 0===e[t]&&(e[t]=0);return e}}static fromCoeffs(t,e=0){let r=d.make();for(let i=0;i<t.length;i++)0!==t[i]&&r.push(u.make(t[i],i+e));return r}minexp(){return 0===this.length?0:this[0].exp}div_by_loop(){if(0===this.length)return d.zero;let e=this.coeffs(),r=this.minexp(),i=d.make(),n=[0,0,0,0];for(let t=0;t<e.length;t++){let s=e[t]-n[3];n.pop(),n.unshift(s),0!==s&&i.push(u.make(-s,t+r+2))}return t(n.every((t=>0===t))),i}gcd(e){return t(e instanceof d),d.fromCoeffs(this.to_poly().gcd(e.to_poly()))}static add(t,e){return t.add(e)}static mul(t,e){return t.mul(e)}static negate(t){return t.simple_mul(-1,0)}static incl(e){return t("number"==typeof e),0===e?d.zero:d.make(u.make(e,0))}static is_zero(t){return t.is_zero()}}d.zero=d.make(),d.unit=d.make(u.make(1,0)),d.t=d.make(u.make(1,1)),d.tinv=d.make(u.make(1,-1));class g extends o{toMathematica(){return"PD["+this.map((t=>t.toMathematica())).join(", ")+"]"}toSnappy(){return"Link(["+this.map((t=>{if(t instanceof _)throw new Error("SnapPy doesn't support P paths");return t.toSnappy()})).join(", ")+"])"}}class m extends o{static make(e,r,i,n){return t(4===arguments.length),super.make(e,r,i,n)}toMathematica(){return"X["+this.join(",")+"]"}toSnappy(){return"("+this.join(",")+")"}}class _ extends o{static make(e,r){return t(2===arguments.length),super.make(e,r)}toMathematica(){return"P["+this.join(",")+"]"}}class y extends m{toMathematica(){return"Xp["+this.join(",")+"]"}}class v extends m{toMathematica(){return"Xm["+this.join(",")+"]"}}class x{constructor(t,e){this.x=t,this.y=e}copy(){return new x(this.x,this.y)}toString(){return"new Point("+this.x+", "+this.y+")"}static equal(e,r){return t(e instanceof x),t(r instanceof x),e.x===r.x&&e.y===r.y}static similar(e,r,i=1e-10){return t(e instanceof x),t(r instanceof x),Math.abs(e.x-r.x)<i&&Math.abs(e.y-r.y)<i}static dist(e,r){t(e instanceof x),t(r instanceof x);var i=e.x-r.x,n=e.y-r.y;return Math.sqrt(i*i+n*n)}static norm_diff(e,r){t(e instanceof x),t(r instanceof x);let i=e.x-r.x,n=e.y-r.y,s=Math.sqrt(i*i+n*n);return t(s>0),new x(i/s,n/s)}}function w(t,e,r,i=1e-10){return b(t,e,r)<=i}function b(e,r,i){if(t(e instanceof x),t(r instanceof x),t(i instanceof x),x.equal(e,r))return x.dist(e,i);let n=r.x-e.x,s=r.y-e.y,o=i.x-e.x,a=i.y-e.y,l=n*n+s*s,h=(n*o+s*a)/l;return h<0?x.dist(i,e):h>1?x.dist(i,r):Math.abs((-s*o+n*a)/Math.sqrt(l))}function k(e,r,i,n,s=1e-10){let o=function(e,r,i,n){t(e instanceof x),t(r instanceof x),t(i instanceof x),t(n instanceof x);let s=e,o=r,a=i,l=n,h=(s.x-o.x)*(a.y-l.y)-(s.y-o.y)*(a.x-l.x);if(0===h)return null;let c=s.x*o.y-s.y*o.x,f=a.x*l.y-a.y*l.x;return new x((c*(a.x-l.x)-f*(s.x-o.x))/h,(c*(a.y-l.y)-f*(s.y-o.y))/h)}(e,r,i,n);return!o||b(e,r,o)>s||b(i,n,o)>s?null:o}function E(e,r,i){return t(e instanceof x),t(r instanceof x),new x((1-i)*e.x+i*r.x,(1-i)*e.y+i*r.y)}function*M(e,r){t(e instanceof x),t(r instanceof x);for(var i=e.x,n=e.y,s=r.x,o=r.y,a=Math.abs(s-i),l=i<s?1:-1,h=-Math.abs(o-n),c=n<o?1:-1,f=a+h;yield new x(i,n),i!==s||n!==o;){var p=2*f;p>=h&&(f+=h,i+=l),p<=a&&(f+=a,n+=c)}}class z{constructor(t,e,r){this.verts=t,this.edges=e,this.adjs=r}copy(){return new z(this.verts.map((t=>t.copy())),this.edges.map((t=>t.slice())),this.adjs.map((t=>t.slice())))}ensure_orientation(){let e=new Set;this.edges.forEach(((r,i)=>{if(e.has(i+1)||e.has(-i-1))return;let n=i+1,s=n;do{e.add(s),e.add(-s);let r=this.dart_edge(s);if(this.dart_start(s)!==r[0]){let e,i;s=-s,[r[0],r[1]]=[r[1],r[0]],e=this.adjs[r[0]],i=e.indexOf(-s),t(i>=0),e[i]=s,e=this.adjs[r[1]],i=e.indexOf(s),t(i>=0),e[i]=-s,t(this.dart_start(s)===r[0])}s=this.through_dart(s)}while(s!==n)}))}reverse_orientation(e){this.dart_circuit(e).forEach((e=>{let r,i,n=this.dart_edge(e);[n[0],n[1]]=[n[1],n[0]],r=this.adjs[n[1]],i=r.indexOf(e),t(i>=0),r[i]=-e,r=this.adjs[n[0]],i=r.indexOf(-e),t(i>=0),r[i]=e}))}make_alternating(){let t=[],e=[],r=()=>{for(;e.length;){let r=e.pop();if(!t[r]){let i=null;this.dart_circuit(r+1).forEach((r=>{t[Math.abs(r)-1]=!0;let n=this.dart_start(r),s=this.adjs[n].indexOf(r)%2==0;4===this.adjs[n].length&&(this.adjs[n].forEach((t=>e.push(Math.abs(t)-1))),i===s&&(this.adjs[n].push(this.adjs[n].shift()),s=!s),i=s)}))}}};for(let i=0;i<this.edges.length;i++)t[i]||(e.push(i),r())}is_alternating(){let t=[];for(let e=0;e<this.edges.length;e++)if(!t[e]){let r=null,i=this.dart_circuit(e+1);for(let e=0;e<i.length;e++){let n=i[e];t[Math.abs(n)-1]=!0;let s=this.dart_start(n),o=this.adjs[s].indexOf(n)%2==0;if(4===this.adjs[s].length){if(r===o)return!1;r=o}}}return!0}bridge_number(){let e=[],r=0;for(let i=0;i<this.edges.length;i++)if(!e[i]){let n=this.dart_circuit(i+1);if(n.forEach((t=>{e[Math.abs(t)-1]=!0})),n.every((t=>2===this.dart_order(t))))r++;else{n=n.filter((t=>4===this.dart_order(t)));let e=0;for(;e<n.length&&this.dart_is_over(n[e]);)e++;if(e===n.length){r++;continue}for(let i=0;i<n.length;){let s=(i+e)%n.length;t(!this.dart_is_over(n[s]));let o=0;for(;i++,s=(i+e)%n.length,this.dart_is_over(n[s]);)o++;o>0&&r++}}}return r}auto_color(e){t(e>0);let r=0,i=new Array(this.edges.length);for(let t=0;t<this.edges.length;t++)if(!i[t]){let n=r++%e;this.dart_circuit(t+1).forEach((t=>{let e=Math.abs(t)-1;i[e]=!0,this.edges[e][2]=n+1}))}}delete_component(t){this.dart_circuit(t).map((t=>Math.abs(t)-1)).forEach((t=>{let r=this.edges[t];e(this.adjs[r[0]],t+1),e(this.adjs[r[0]],-t-1),e(this.adjs[r[1]],t+1),e(this.adjs[r[1]],-t-1),this.edges[t]=null})),this.compact()}compact(){let t=[];for(let e=0;e<this.verts.length;e++)if(this.adjs[e]&&0===this.adjs[e].length)this.verts[e]=null;else if(null!==this.verts[e]){let r=t.length;t.push(this.verts[e]),this.verts[e]=r}let e=[];for(let t=0;t<this.edges.length;t++){let r=this.edges[t];if(null!==r){let i=e.length;this.edges[t]=i,e.push([this.verts[r[0]],this.verts[r[1]],r[2]])}}let r=[];for(let t=0;t<this.verts.length;t++){let e=this.adjs[t];if(null!==this.verts[t]){let t=[];e.forEach((e=>{let r=this.edges[Math.abs(e)-1];null!==r&&t.push(Math.sign(e)*(r+1))})),r.push(t)}}this.verts=t,this.edges=e,this.adjs=r}unsubdivide(e){t(2===this.adjs[e].length);let r=Math.abs(this.adjs[e][0]);this.dart_end(r)!==e&&(r=Math.abs(this.adjs[e][1])),t(this.dart_end(r)===e);let i=r-1,n=this.through_dart(r)-1;t(n>=0);let s=this.edges[i],o=this.edges[n],a=this.dart_end(this.through_dart(r)),l=this.adjs[a].indexOf(this.opp_dart(this.through_dart(r)));t(l>=0),s[1]=o[1],this.adjs[a][l]=this.opp_dart(r),this.verts[e]=null,this.adjs[e]=null,this.edges[n]=null}simplify_mesh(t=2){let e=!0;for(;e;){e=!1;t:for(let e=0;e<this.verts.length;e++){let r=this.verts[e];if(null===r)continue t;let i=this.adjs[e];if(2===i.length){let n=this.dart_end(i[0]),s=this.dart_end(i[1]),o=this.verts[n],a=this.verts[s],l=o.x-r.x,h=o.y-r.y,c=a.x-r.x,f=a.y-r.y,p=o.x-a.x,u=o.y-a.y,d=l*f-c*h;if(Math.abs(d)/Math.sqrt(p*p+u*u)<=t){for(let t=0;t<this.edges.length;t++)if(t!==Math.abs(i[0])-1&&t!==Math.abs(i[1])-1){let e=this.edges[t];if(null===e)continue;if(k(this.verts[e[0]],this.verts[e[1]],o,a))continue t}this.unsubdivide(e),this.do_remove=!0}}}}}dart_start(t){return this.dart_edge(t)[t>0?0:1]}dart_end(e){return t("number"==typeof e),this.dart_edge(e)[e>0?1:0]}dart_edge(e){return t("number"==typeof e),this.edges[Math.abs(e)-1]}dart_order(t){return this.adjs[this.dart_start(t)].length}dart_is_over(e){t("number"==typeof e);let r=this.adjs[this.dart_start(e)];t(4===r.length);let i=r.indexOf(e);return t(i>=0),i%2==1}next_dart(e){t("number"==typeof e);let r=this.adjs[this.dart_start(e)],i=r.indexOf(e);return t(i>=0),r[(i+1)%r.length]}prev_dart(e){t("number"==typeof e);let r=this.adjs[this.dart_start(e)],i=r.indexOf(e);return t(i>=0),r[(i+r.length-1)%r.length]}opp_dart(e){return t("number"==typeof e),t(0!==e&&Math.abs(e)<=this.edges.length),-e}dart_oriented(t){let e=this.dart_edge(t);return this.dart_start(t)===e[0]}through_dart(t){let e=this.opp_dart(t);switch(this.dart_order(e)){case 2:return this.next_dart(e);case 4:return this.next_dart(this.next_dart(e));default:throw new Error("Unexpected dart order")}}dart_circuit(t){let e=[],r=t;do{e.push(r),r=this.through_dart(r)}while(r!==t);return e}crossing_number(){let t=0;return this.adjs.forEach((e=>{4===e.length&&t++})),t}writhe(){let t=0;return this.adjs.forEach(((e,r)=>{4===e.length&&(this.dart_oriented(e[1])===this.dart_oriented(e[2])?t+=1:t-=1)})),t}linking_matrix(){let t=new Map;function e(e){t.has(e)||(t.set(e,new Map),t.get(e).set(e,0))}function r(e,r,i){let n=t.get(e);n.set(r,(n.get(r)||0)+i);let s=t.get(r);s.set(e,(s.get(e)||0)+i)}return this.adjs.forEach(((t,i)=>{if(2===t.length){e(this.dart_edge(t[0])[2])}else if(4===t.length){let i=this.dart_edge(t[1])[2],n=this.dart_edge(t[2])[2];e(i),e(n),this.dart_oriented(t[1])===this.dart_oriented(t[2])?r(i,n,.5):r(i,n,-.5)}})),t}num_components(){let t=new Set,e=0;for(let r=0;r<this.edges.length;r++)t.has(r)||(e++,this.dart_circuit(r+1).forEach((e=>{t.add(e)})));return e}seifert_circuit(t){let e=[],r=t;do{e.push(r),r=this.opp_dart(r),r=this.dart_oriented(r)===this.dart_oriented(this.next_dart(r))?this.prev_dart(r):this.next_dart(r)}while(r!==t);return e}genus(){let t=new Set,e=e=>{let r=0,i=[e];for(;i.length>0;){let e=i.pop();t.has(e)||(r++,this.seifert_circuit(e).forEach((e=>{i.push(...this.adjs[this.dart_start(e)]),t.add(e),t.add(this.opp_dart(e))})))}return r},r=0,i=0;for(let n=0;n<this.edges.length;n++)t.has(n+1)||(r++,i+=e(n+1));return r-(i-this.crossing_number()+this.num_components())/2}seifert_form(){let e=new Array(this.edges.length);e.fill(-1);let r=0;let i=i=>{let n=[i],o=new Map,a=[];function l(e,r,i){for(let n=0;n<a.length;n++){let s=a[n];if(s[1]===e&&s[2]===r)return t(i===s[3]),s[0]}let n=a.length;return a.push([n,e,r,i]),n}for(;n.length>0;){let i=n.pop();if(-1!==e[i])continue;let s=-1===e[h=i]?e[h]=r++:e[h],a=this.seifert_circuit(i+1);a.forEach((r=>{t(r>0),e[r-1]=s})),a=a.filter((t=>4===this.dart_order(t)));let c=[];o.set(s,c),a.forEach((e=>{let r,i,s,o=e-1,a=this.adjs[this.dart_start(e)].indexOf(e);if(this.dart_oriented(this.next_dart(e))?(r=this.next_dart(e)-1,i=1-a%2*2,s=!1):(r=this.prev_dart(e)-1,i=a%2*2-1,s=!0),t(r>=0),n.push(r),s){let t=l(o,r,i);c.push(t+1)}else{let t=l(r,o,i);c.push(-t-1)}}))}var h;a.forEach((t=>{t[1]=e[t[1]],t[2]=e[t[2]]}));let c=new Map;c.set(a[0][1],null);let f=a.slice(),p=[];for(;f.length>0;){let e;for(let t=0;t<f.length;t++)if(e=f[t],c.has(e[1])||c.has(e[2])){f.splice(t,1);break}t(e),c.has(e[1])&&c.has(e[2])?p.push(e):c.has(e[1])?c.set(e[2],-e[0]-1):c.set(e[1],e[0]+1)}function u(e){for(let t=0;t<a.length;t++)if(a[t][0]===e)return a[t];return t(!1)}let d=p.map((e=>function(e){let r=[],i=[];for(let n=0;n<e.length;n++){let[s,a]=e[n],[l,h]=e[(n+1)%e.length];r.push([a[0],a[3],s]);let c=a[1+s],f=o.get(c),p=s?-a[0]-1:a[0]+1,u=l?h[0]+1:-h[0]-1,d=f.indexOf(p),g=f.indexOf(u);t(-1!==d&&-1!==g),i.push([c,d,p>0,g,u>0])}return{edges:r,verts:i}}(function(t){let e,r=[[!0,t]];for(e=t[1];null!==c.get(e);){let t=c.get(e),i=u(Math.abs(t)-1);r.unshift([t<0,i]),e=i[1+(t>0)]}for(e=t[2];null!==c.get(e);){let t=c.get(e),i=u(Math.abs(t)-1);r.push([t>0,i]),e=i[1+(t>0)]}for(;r[0][1][0]===r[r.length-1][1][0];)r.pop(),r.shift();return r}(e)))),g=d.map((t=>d.map((e=>function(t,e){let r=0;return t.edges.forEach((t=>{let[i,n,s]=t;e.edges.forEach((t=>{if(i===t[0]){let e=t[2];n>0&&(r+=2*(s===e)-1)}}))})),t.verts.forEach((t=>{let[i,n,s,o,a]=t;e.verts.forEach((t=>{if(i===t[0]){let[e,i,l,h,c]=t,f=1;n>o&&(f=-1,[n,s,o,a]=[o,a,n,s]);let p=1;i>h&&(p=-1,[i,l,h,c]=[h,c,i,l]),s&&i<n&&n<=h&&(r+=f*p),a&&i<o&&o<=h&&(r-=f*p)}}))})),r}(t,e)))));return console.log(s(g)),g},n=[];for(let t=0;t<this.edges.length;t++)4===this.dart_order(t+1)&&-1===e[t]&&n.push(i(t));for(let t=0;t<this.edges.length;t++)2===this.dart_order(t+1)&&-1===e[t]&&(n.push([]),this.dart_circuit(t+1).forEach((t=>{e[Math.abs(t)-1]=!0})));return n}turaev(){let t=new Set,e=0,r=0,i=!0,n=!0;for(let s=0;s<this.edges.length;s++)if(!t.has(s+1)){e++;let o=[[s+1,!1]];for(;o.length>0;){let[e,s]=o.pop();if(t.has(e))continue;r++;let a=new Set,l=e;do{a.has(l)&&(s?i=!1:n=!1);{let t=s,e=l;do{t=!t,e=this.next_dart(e),o.push([e,t])}while(l!==e)}t.add(l),l=this.opp_dart(l);let e=this.adjs[this.dart_start(l)];2===e.length?l=this.next_dart(l):(l=e.indexOf(l)%2==0===s?this.next_dart(l):this.prev_dart(l),e.forEach((t=>{l!==t&&(a.add(t),a.add(this.opp_dart(t)))})))}while(l!==e)}}return{genus:e+(this.crossing_number()-r)/2,plus:i,minus:n}}get_pd(t=!1){let e=new Map,r=1,i=g.make(),n=this.edges.map(((t,e)=>e));n.sort(((t,e)=>this.edges[t][2]-this.edges[e][2]));for(let t=0;t<n.length;t++){let s=n[t];if(e.has(s+1))continue;let o=this.dart_circuit(s+1);if(o.every((t=>2===this.dart_order(t)))){let t=r++;i.push(_.make(t,t)),o.forEach((r=>{e.set(r,t),e.set(-r,t)}))}else{let t=0;for(;4!==this.dart_order(o[t]);)t++;o=o.slice(t).concat(o.slice(0,t));let i=null;o.forEach((t=>{4===this.dart_order(t)&&(i=r++),e.set(t,i),e.set(-t,i)}))}}return this.adjs.forEach((r=>{if(4===r.length){this.dart_oriented(r[2])||(r=r.slice(2).concat(r.slice(0,2)));let n=r.map((t=>e.get(t)));t?this.dart_oriented(r[1])?i.push(y.make(...n)):i.push(v.make(...n)):i.push(m.make(...n))}})),i}get_dt(){if(1!==this.num_components())return null;let t=this.dart_circuit(1).filter((t=>4===this.dart_order(t)));if(0===t.length)return[];let e=t.length,r=r=>{let i=new Map;t.forEach(((t,n)=>{i.set(t,(n+e-r)%e)}));let n=t=>{let e=i.get(this.next_dart(t));return void 0===e&&(e=i.get(this.prev_dart(t))),e},s=[];for(let i=0;i<t.length;i+=2){let o=n(t[(i+r)%e]);this.dart_is_over(t[(i+r)%e])?s.push(-o-1):s.push(o+1)}if(s[0]<0)for(let t=0;t<s.length;t++)s[t]=-s[t];return s},n=[];for(let e=0;e<t.length;e++)n.push(r(e));t=this.dart_circuit(-1).filter((t=>4===this.dart_order(t)));for(let e=0;e<t.length;e++)n.push(r(e));return n.sort(i),n[0]}skeleton(){let t=[],e=[],r=new Set;for(let i=0;i<this.edges.length;i++){if(r.has(i))continue;let n=this.dart_circuit(i+1);if(n.every((t=>2===this.dart_order(t)))){e.push(this.edges[i][2]),n.forEach((t=>r.add(Math.abs(t)-1)));continue}let s=1,o=new Map,a=new Map,l=new Set,h=[i];for(;h.length>0;){let t=h.pop();if(r.has(t))continue;let e=this.edges[t][2],i=this.dart_circuit(t+1),n=0;for(;4!==this.dart_order(i[n]);)n++;i=i.slice(n).concat(i.slice(0,n));let c=null;i.forEach((t=>{if(4===this.dart_order(t)){c=s++,a.set(c,e);let i=this.dart_edge(t)[0];l.add(i),this.adjs[i].forEach((t=>{let e=Math.abs(t)-1;r.has(e)||h.push(e)}))}o.set(Math.abs(t)-1,c),r.add(Math.abs(t)-1)}))}let c=[];l.forEach((t=>{let e=this.adjs[t].map((t=>{let e=o.get(Math.abs(t)-1);return t>0?e:-e}));for(let t=0;t<e.length;t++)if(e[t]<0&&(e[t]===-e[(t+1)%e.length]||e[t]===-e[(t+e.length-1)%e.length])){let r=-e[t],i=s++;c.push([i,-r]),e[t]=-i,a.has(r)?a.set(i,a.get(r)):a.set(-i,a.get(-r))}c.push(e)})),t.push({verts:c,vert_types:c.map((t=>"")),knot:c,comps:a})}return{loops:e,parts:t}}beautify(){function e(e){function r(t){let r=[],i=t;t:for(;;){for(let n=0;n<e.verts.length;n++){let s=e.verts[n].indexOf(-i);if(-1!==s){if(i=e.verts[n][(s+e.verts[n].length-1)%e.verts[n].length],r.push(i),i===t)break t;continue t}}throw new Error}return r}function i(t){return Math.min(...r(t))}var n=1,s=new Map;function o(t){return"[v "+t+"]"}function a(t){return"[e "+Math.abs(t)+"]"}function l(t){return"[f "+i(t)+"]"}function h(t){return s.has(t)||s.set(t,n++),s.get(t)}let c=new Map,f=new Map,p=[],u=[];e.verts.forEach(((t,r)=>{let i=[];t.forEach(((t,e)=>{i.push(h(o(r)+a(t))),c.set(t,h(o(r)+a(t))),i.push(h(o(r)+e+l(t)))})),p.push(i),u.push(e.vert_types[r]+"v")})),e.verts.forEach(((t,r)=>{t.forEach(((t,i)=>{if(t<0)return;let n=[];n.push(h(a(t)+l(t))),n.push(-h(o(r)+a(t))),f.set(-t,-h(o(r)+a(t)));for(let r=0;r<e.verts.length;r++){if(-1!=e.verts[r].indexOf(-t))return n.push(h(a(t)+l(-t))),n.push(-h(o(r)+a(t))),f.set(t,-h(o(r)+a(t))),p.push(n),void u.push("e")}throw new Error}))}));let d=new Set;e.verts.forEach((t=>{t.forEach((t=>{let n=i(t);if(d.has(n))return;d.add(n);let s=[];r(t).forEach((t=>{for(let r=0;r<e.verts.length;r++){let i=e.verts[r].indexOf(t);if(-1!==i){s.push(-h(o(r)+i+l(n)));break}}s.push(-h(a(t)+l(n)))})),p.push(s),u.push("f")}))}));let g=e.knot.map((t=>t.map((t=>c.get(t))))),m=new Map;e.comps.forEach(((t,e)=>{let r=c.get(e),i=f.get(e);m.set(r,t),m.set(i,t),g.push([-r,i])}));{let e=new Set;p.forEach((r=>r.forEach((r=>{t(!e.has(r)),e.add(r)})))),e.forEach((r=>{t(e.has(-r))}))}return{verts:p,vert_types:u,knot:g,comps:m}}let r=this.skeleton();console.log(r),this.verts=[],this.edges=[],this.adjs=[];let i=r.loops.length+r.parts.length,n=Math.ceil(Math.sqrt(i)),s=0,o=0;r.loops.forEach((t=>{let e=800/n*(o+.5),r=800/n*(s+.5),i=640/n/2;const a=30;let l=[];for(let t=0;t<a;t++){let n=this.verts.length;this.verts.push(new x(e+i*Math.cos(2*Math.PI*t/a),r-i*Math.sin(2*Math.PI*t/a))),l.push(n)}let h=[];for(let e=0;e<a;e++){let r=this.edges.length;this.edges.push([l[e],l[(e+1)%a],t]),h.push(r)}for(let t=0;t<a;t++)this.adjs.push([h[t]+1,-h[(t+a-1)%a]-1]);o++,o>=n&&(o=0,s++)})),r.parts.forEach((t=>{let r=800/n*(o+.5),i=800/n*(s+.5),a=640/n/2;t=e(t),t=e(t),console.log(t);let l=null,h=0;t.verts.forEach(((e,r)=>{"fv"==t.vert_types[r]&&h<e.length&&(h=e.length,l=r)})),console.log("best: "+l);let c=new Map;function f(t){let e=t.length,r=t[0].length,i=0,n=0;for(;i<e&&n<r;){let s=i;for(let r=i+1;r<e;r++)Math.abs(t[r][n])>Math.abs(t[s][n])&&(s=r);if(s!==i&&([t[i],t[s]]=[t[s],t[i]]),0===t[i][n]){n++;continue}let o=t[i][n];t[i]=t[i].map((t=>t/o));for(let s=0;s<e;s++)if(s!==i){o=t[s][n],t[s][n]=0;for(let e=n+1;e<r;e++)t[s][e]-=o*t[i][e]}i++,n++}}t.verts.forEach(((t,e)=>{t.forEach((t=>{c.set(t,e)}))}));let p=[],u=[],d=new Set;t.verts[l].forEach(((e,r)=>{let i=c.get(-e);d.add(i);let n=new Array(t.verts.length+1).fill(0);n[i]=1,n[t.verts.length]=Math.cos(2*Math.PI*r/h);let s=new Array(t.verts.length+1).fill(0);s[i]=1,s[t.verts.length]=Math.sin(2*Math.PI*r/h),p.push(n),u.push(s)})),t.verts.forEach(((e,r)=>{if(r===l||d.has(r))return;let i=new Array(t.verts.length+1).fill(0);e.forEach((t=>{let e=c.get(-t);i[e]+=1,i[r]-=1})),p.push(i),u.push(i.slice())})),f(p),f(u);var g=[];t.knot.forEach((e=>{g.push(function(e){if(e<l)return new x(p[e][t.verts.length],u[e][t.verts.length]);if(e===l)throw new Error;return new x(p[e-1][t.verts.length],u[e-1][t.verts.length])}(c.get(e[0])))}));let m=1e10,_=-1e10,y=1e10,v=-1e10;g.forEach((t=>{m=Math.min(m,t.x),_=Math.max(_,t.x),y=Math.min(y,t.y),v=Math.max(v,t.y)})),g.forEach((t=>{let e=t.x-(m+_)/2,n=t.y-(y+v)/2,s=Math.max(_-m,v-y)/2;t.x=r+e/s*a,t.y=i+n/s*a}));let w=[];g.forEach((t=>{let e=this.verts.length;this.verts.push(t),w.push(e)}));let b=new Map;t.knot.forEach(((t,e)=>{t.forEach((t=>{b.set(t,e)}))}));let k=new Map;t.comps.forEach(((t,e)=>{let r=this.edges.length;k.set(e,r),this.edges.push([w[b.get(e)],w[b.get(-e)],t])})),t.knot.forEach(((t,e)=>{this.adjs.push(t.map((t=>k.has(t)?k.get(t)+1:-1-k.get(-t))))})),o++,o>=n&&(o=0,s++)})),console.log(this)}}class T{constructor(t,e){t>e&&([t,e]=[e,t]),this[0]=t,this[1]=e}equal(e){return t(e instanceof T),this[0]===e[0]&&this[1]===e[1]}compare(e){t(e instanceof T);let r=this[0]-e[0];return 0!==r?r:this[1]-e[1]}static make(e,r){return t(2===arguments.length),new this(e,r)}toString(){return"TLPath.make("+this[0]+", "+this[1]+")"}}class j{constructor(t,e){this.coeff=t,this.paths=e}static make(t,e){return new this(t,e)}toString(){return"TLTerm.make("+this.coeff+", "+s(this.paths)+")"}equal(e){return t(e instanceof j),r(this.coeff,e.coeff)&&r(this.paths,e.paths)}normalize(){let t=this.coeff,e=this.paths,r=0;t:for(;r<e.length;){let i=e[r];if(i[0]===i[1]){t=t.mul(C.loop),e.splice(r,1);continue t}let n=r+1;for(;n<e.length;){let t=e[n];for(let s=0;s<2;s++)for(let o=0;o<2;o++)if(i[s]===t[o]){e[r]=T.make(i[1-s],t[1-o]),e.splice(n,1);continue t}n++}r++}return this.coeff=t,e.sort(((t,e)=>t[0]-e[0])),this}}class C extends o{copy(){return this.slice()}normalize(){this.forEach((t=>t.normalize())),this.sort(((t,e)=>i(t.paths,e.paths)));let t=0;for(;t<this.length;){let e=this[t],r=e.coeff,n=t+1;for(;n<this.length&&0===i(e.paths,this[n].paths);)r=r.add(this[n].coeff),n++;0===r.length?this.splice(t,n-t):(e.coeff=r,n-t-1>0&&this.splice(t+1,n-t-1),t++)}return this}add(e){return t(e instanceof C),this.concat(e).normalize()}mul(e){t(e instanceof C);let r=C.make();return this.forEach((t=>{e.forEach((e=>{r.push(j.make(t.coeff.mul(e.coeff),t.paths.concat(e.paths)))}))})),r.normalize()}}C.unit=C.make(j.make(d.unit,[])),C.loop=d.fromCoeffs([-1,0,0,0,-1],-2);let q=new WeakMap,A={},P=[];function S(r,i){t(r in A);let n=Array.prototype.slice.call(arguments,2),o=r+s(n),a=q.get(i);if(a&&a[o])return a[o];a||(a={},q.set(i,a));let l={_canceled:!1,cancel:()=>{l._canceled=!0},next_turn:()=>new Promise(((t,e)=>{l._canceled?e("canceled"):setTimeout(t,0)}))};P.push(l);let h=new Promise(((t,s)=>{setTimeout((async function(){try{let s=A[r](l,i,...n);t(s)}catch(t){s(t)}finally{e(P,l)}}),0)}));return a[o]=h,h}function D(e,r){t(!A[e]),A[e]=r}function N(e,r){if(0===r.length)return e.unit;if(t(r.length===r[0].length),1===r.length)return r[0][0];if(2===r.length)return e.add(e.mul(r[0][0],r[1][1]),e.negate(e.mul(r[1][0],r[0][1])));if(3===r.length)return e.add(e.add(e.add(e.mul(e.mul(r[0][0],r[1][1]),r[2][2]),e.mul(e.mul(r[0][1],r[1][2]),r[2][0])),e.mul(e.mul(r[0][2],r[1][0]),r[2][1])),e.negate(e.add(e.add(e.mul(e.mul(r[0][0],r[2][1]),r[1][2]),e.mul(e.mul(r[0][1],r[2][2]),r[1][0])),e.mul(e.mul(r[0][2],r[2][0]),r[1][1]))));let i=e.zero;for(let t=0;t<r[0].length;t++){let n=r[0][t];if(e.is_zero(n))continue;t%2==1&&(n=e.negate(n));let s=[];for(let e=1;e<r.length;e++)s.push(r[e].slice(0,t).concat(r[e].slice(t+1)));i=e.add(i,e.mul(N(e,s),n))}return i}D("kauffman_bracket",(async function(r,i){if(!(i instanceof g))return await S("kauffman_bracket",i.get_pd());if(0===i.length)return null;i=i.slice();let n=[],s=C.unit;for(;i.length>0;){await r.next_turn();let t=-1,o=null;i.forEach(((e,r)=>{let i=0;e.forEach((t=>{-1!==n.indexOf(t)&&i++})),i>t&&(t=i,o=r)}));let a=i[o];i.splice(o,1);let l=null;if(2===a.length){let[t,e]=a;l=new C(new j(d.unit,[new T(t,e)]))}else{let[t,e,r,i]=a;l=new C(new j(d.t,[new T(t,e),new T(r,i)]),new j(d.tinv,[new T(t,i),new T(e,r)]))}s=s.mul(l),a.forEach((t=>{e(n,t)||n.push(t)}))}return t(s.length<=1),0===s.length?d.zero:(t(0===s[0].paths.length),s[0].coeff.div_by_loop())})),D("jones_poly",(async function(e,r){let i;r instanceof g?(i=0,r.forEach((t=>{if(4===t.length)if(t.constructor===y)i++;else{if(t.constructor!==v)throw new TypeError;i--}}))):(t(r instanceof z),i=r.writhe());let n=await S("kauffman_bracket",r);if(null===n)return null;let s=n.simple_mul(Math.pow(-1,i),-3*i),o=new d;for(let e=s.length-1;e>=0;e--){let r=s[e],i=-r.exp/2;t(i===Math.floor(i)),o.push(new u(r.coeff,i))}return o}));class I extends o{normalize(){let e=0;for(;e<this.length;){if(this[e]instanceof I){let t=this[e],r=this[e+1];r<0&&(t=t.inverse(),r=-r),this.splice(e,2);for(let i=0;i<r;i++)this.splice(e,0,...t);e=Math.max(0,e-2);continue}let t=this[e+1],r=e+2;for(;r<this.length&&this[e]===this[r];)t+=this[r+1],r+=2;0===t?(this.splice(e,r-e),e=Math.max(0,e-2)):(this[e+1]=t,r-e-2>0&&this.splice(e+2,r-e-2),e+=2)}return t(e===this.length),this}normalize_conj(t=!0){let e=this.slice();for(;e.normalize(),e.length>2&&e[0]===e[e.length-2];)e[1]+=e[e.length-1],e.length=e.length-2;if(!t||0===e.length)return e;let r=[];for(let t=0;t<e.length;t+=2){let i=e.slice(t).concat(e.slice(0,t));r.push(i),r.push(i.inverse())}return r.sort(i),r[0]}inverse(){let t=I.make();for(let e=this.length-2;e>=0;e-=2)t.push(this[e],-this[e+1]);return t}fox_deriv(t){if(0===this.length)return O.zero;if(2===this.length&&1===this[1])return t===this[0]?O.unit:O.zero;if(2===this.length&&-1===this[1])return t===this[0]?O.make([-1,I.make(this[0],-1)]):O.zero;{let e=this.slice(0,2),r=this.slice(2);return 0===r.length&&(r.push(e[0],e[1]-Math.sign(e[1])),e[1]=Math.sign(e[1])),e.fox_deriv(t).add(O.make([1,e]).mul(r.fox_deriv(t)))}}substitute(t,e){let r=this.slice();for(let i=0;i<this.length;i+=2)(t instanceof Function&&t(r[i])||t===r[i])&&(r[i]=e);return r.normalize()}}class O extends o{static gen(t,e=1,r=1){return O.make([r,I.make(t,e)]).normalize()}normalize(){this.forEach((t=>t[1].normalize())),this.sort(((t,e)=>i(t[1],e[1])));let t=0;for(;t<this.length;){let e=this[t],r=e[0],n=t+1;for(;n<this.length&&0===i(e[1],this[n][1]);)r+=this[n][0],n++;0===r.length?this.splice(t,n-t):(e[0]=r,n-t-1>0&&this.splice(t+1,n-t-1),t++)}return this}scale(e){if(t("number"==typeof e),0===e)return O.zero;let r=O.make();return this.forEach((t=>{r.push([t[0]*e,t[1]])})),r}add(e){return t(e instanceof O),this.concat(e).normalize()}mul(e){t(e instanceof O);let r=O.make();return this.forEach((t=>{e.forEach((e=>{r.push([t[0]*e[0],t[1].concat(e[1])])}))})),r.normalize()}substitute(t,e){return this.map((r=>[r[0],r[1].substitute(t,e)])).normalize()}toLaurent(){let t=d.make();return this.forEach((e=>{let r=0;for(let t=0;t<e[1].length;t+=2)r+=e[1][t+1];t.push(u.make(e[0],r))})),t.normalize()}}function L(e){let r=e.gens.map((t=>e.rels.map((t=>d.zero))));return e.rels.forEach(((t,i)=>{let n=0;for(let s=0;s<t.length;s+=2){let o=e.gens.indexOf(t[s]),a=Math.sign(t[s+1]),l=Math.abs(t[s+1]);for(let t=0;t<l;t++){let t;t=a>0?d.make(u.make(1,n)):d.make(u.make(-1,n-1)),r[o][i]=r[o][i].add(t),n+=a}}})),r.pop(),function(e){if(0===e.length)return[];let r=1/0;e.forEach((t=>t.forEach((t=>{t.is_zero()||(r=Math.min(r,t.minexp()))})))),r===1/0&&(r=0);let i=e.map((t=>t.map((t=>t.simple_mul(1,-r).to_poly(!0)))));function n(t){let e=1/0;for(let r=0;r<i[t].length;r++){let n=i[t][r];e=Math.min(e,n.min_exp())}if(e<1/0)for(let r=0;r<i[t].length;r++)i[t][r]=i[t][r].mul_x(-e)}function s(t){let e=1/0;for(let r=0;r<i.length;r++){let n=i[r][t];e=Math.min(e,n.min_exp())}if(e<1/0)for(let r=0;r<i.length;r++)i[r][t]=i[r][t].mul_x(-e)}function o(t){for(let e=0;e<i.length;e++)i[e].splice(t,1)}function a(t){let e=!0;for(let r=0;r<i.length;r++)e=e&&i[r][t].is_zero();e&&o(t)}function l(t,e){if(t!==e)for(let r=0;r<i.length;r++)[i[r][t],i[r][e]]=[i[r][e],i[r][t]]}function h(t,e,r,n){for(let s=0;s<i.length;s++)i[s][t]=i[s][t].add(i[s][e].scale(r).mul_x(n))}for(let t=i[0].length-1;t>=0;t--)a(t);for(let t=0;t<i.length;t++)n(t);for(let t=0;t<i[0].length;t++)s(t);function c(){if(0===i.length)return!1;let t=!1,e=0,r=0;t:for(;e<i.length&&r<i[0].length;)if(i[e][r].is_zero()){for(let n=r+1;n<i[0].length;n++)if(!i[e][n].is_zero()){l(r,n),t=!0;continue t}e++}else{if(i[e][r].leading_coeff()<0)for(let t=e;t<i.length;t++)i[t][r]=i[t][r].scale(-1);{let n=i[e][r],o=n.degree(),l=r+1;for(;l<i[0].length;){let c=i[e][l],f=c.degree();if(o<=f&&n.leading_coeff()<=Math.abs(c.leading_coeff())){let e=c.leading_coeff()/n.leading_coeff();h(l,r,-(Math.sign(e)*Math.floor(Math.abs(e))),f-o),s(l),a(l),t=!0}else l++}}{let n=r,s=i[e][r].degree(),o=i[e][r].leading_coeff();for(let t=r+1;t<i[0].length;t++){let r=i[e][t];!r.is_zero()&&r.degree()<=s&&Math.abs(r.leading_coeff())<=o&&(n=t,s=r.degree(),o=Math.abs(r.leading_coeff()))}if(n!==r){l(r,n),t=!0;continue t}}{let t=!0;for(let n=r+1;n<i[0].length;n++)t=t&&i[e][n].is_zero();if(!t)break t}e++,r++}return t}function f(){let e=0;t:for(;i.length>0&&e<i[0].length;){let r=null;for(let t=0;t<i.length;t++){let n=i[t][e];if(!n.is_zero()){if(null!==r||0!==n.degree()||1!=Math.abs(n[0])){e++;continue t}r=t}}t(null!==r),o(e),i.splice(r,1)}}function p(){let t=i.length,e=t>0?i[0].length:0,r=new Array(e);for(let n=0;n<e;n++){r[n]=new Array(t);for(let e=0;e<t;e++)r[n][e]=i[e][n]}i=r}for(let t=4;t>0;t--){let t=!1;if(t=c()||t,0===i.length)break;if(f(),0===i.length)break;if(i.reverse().forEach((t=>t.reverse())),t=c()||t,0===i.length)break;if(f(),0===i.length)break;let e=i;if(p(),t=c()||t,0===i.length){i=e;break}if(i.reverse().forEach((t=>t.reverse())),t=c()||t,0===i.length){i=e;break}if(p(),f(),!t||0===i.length)break}return i.map((t=>t.map((t=>d.fromCoeffs(t)))))}(r)}function R(t,e=0){let r=t.length-e;if(r<=0)return d.unit;let i=d.zero,n=[];let s=[];for(let t=0;t<r;t++)s.push([]);function o(e){if(s[0].length===r)i=i.gcd(N(d,s));else for(let i=e;i<t[0].length-(r-s[0].length-1);i++){for(let t=0;t<r;t++)s[t].push(n[t][i]);o(i+1);for(let t=0;t<r;t++)s[t].pop()}}!function e(i){if(n.length===r)o(0);else for(let s=i;s<t.length-(r-n.length-1);s++)n.push(t[s]),e(s+1),n.pop()}(0);let a=i.coeffs();return a[0]<0&&(a=a.map((t=>-t))),d.fromCoeffs(a,0)}O.zero=O.make(),O.unit=O.make([1,I.make()]),D("wirtinger_presentation",(async function(t,e){return function(t){t instanceof g||(t=t.get_pd(!0));let e=[],r=[];t.forEach((t=>{if(t.forEach((t=>{void 0===e[t]&&(e[t]="x"+t)})),t instanceof _){let i=e[t[0]],n=e[t[1]];r.push(I.make(i,1,n,-1))}else if(t instanceof y){let i=e[t[0]],n=e[t[1]],s=e[t[2]],o=e[t[3]];r.push(I.make(o,1,n,-1)),r.push(I.make(n,1,s,1,o,-1,i,-1))}else{if(!(t instanceof v))throw new TypeError;{let i=e[t[0]],n=e[t[1]],s=e[t[2]],o=e[t[3]];r.push(I.make(o,1,n,-1)),r.push(I.make(s,1,o,1,i,-1,n,-1))}}}));let n=new Set;t:for(;;){r=r.map((t=>t.normalize_conj(!1))).filter((t=>t.length>0)),r.sort(i);let t=0;for(;t+1<r.length;)0===i(r[t],r[t+1])?r.splice(t+1,1):t++;for(let t=0;t<r.length;t++){let e=r[t];e:for(let i=0;i<e.length;i+=2){let s=e[i];if(1===Math.abs(e[i+1])){for(let t=0;t<e.length;t+=2)if(t!==i&&e[t]===s)continue e;let o=e.slice(i+2).concat(e.slice(0,i));1===e[i+1]&&(o=o.inverse()),n.add(s),r.splice(t,1),r=r.map((t=>t.substitute(s,o)));continue t}}}break}return{gens:e.filter((t=>!n.has(t))),rels:r}}(e)})),D("alexander_module",(async function(t,e){return L(await S("wirtinger_presentation",e))})),D("alexander_poly",(async function(t,e,r){if(2===arguments.length)return await S("alexander_poly",e,0);let i=await S("alexander_module",e);return await t.next_turn(),R(i,r)}));class U{constructor(e,r){if(t(e instanceof p),t(r instanceof p),e.is_zero())return this.p=p.zero,void(this.q=p.unit);if(r.is_unit())return this.p=e,void(this.q=p.unit);let i=e.gcd(r);this.p=e.divide(i),this.q=r.divide(i),this.q.leading_coeff()<0&&(this.p=this.p.scale(-1),this.q=this.q.scale(-1))}toString(){return"new RatFun("+this.p+", "+this.q+")"}is_zero(){return this.p.is_zero()}add(e){return t(e instanceof U),new U(this.p.mul(e.q).add(this.q.mul(e.p)),this.q.mul(e.q))}scale(t){return new U(this.p.scale(t),this.q)}mul(e){t(e instanceof U);let r=new U(this.p,e.q),i=new U(e.p,this.q);return new U(r.p.mul(i.p),r.q.mul(i.q))}div(e){t(e instanceof U);let r=new U(this.p,e.p),i=new U(e.q,this.q);return new U(r.p.mul(i.p),r.q.mul(i.q))}recip(){return new U(this.q,this.p)}static incl(t){return U.from_poly(p.incl(t))}static from_poly(e){return t(e instanceof p),new U(e,p.unit)}static from_laurent(e){return t(e instanceof d),e.minexp()<0?new U(e.to_poly(),p.incl(1).mul_x(-e.minexp())):U.from_poly(e.to_poly(!0))}}U.unit=U.incl(1),U.zero=U.incl(0),D("conway_poly",(async function(e,r){let i=r.seifert_form();if(1!==i.length)return d.zero;let n=i[0],s=[];for(let t=0;t<n.length;t++){s.push([]);for(let e=0;e<n.length;e++)s[t][e]=d.add(d.mul(d.incl(-n[t][e]),d.t),d.mul(d.incl(n[e][t]),d.tinv))}let o=function(e){if(0==e.length)return d.unit;let r=e.map((t=>t.map((t=>U.from_laurent(t))))),i=r.length,n=r[0].length;t(i===n);let s=U.unit,o=0,a=0;for(;o<i&&a<n;){if(r[o][a].is_zero()){for(let t=o+1;t<i;t++)if(!r[t][a].is_zero()){[r[o],r[t]]=[r[t],r[o]],s=s.scale(-1);break}if(r[o][a].is_zero())return d.zero}let t=r[o][a];if(s=s.mul(t),s.is_zero())return d.zero;r[o]=r[o].map((e=>e.div(t)));for(let e=o+1;e<i;e++){t=r[e][a],r[e][a]=U.zero;for(let i=a+1;i<n;i++)r[e][i]=r[e][i].add(r[o][i].mul(t).scale(-1))}o++,a++}for(let e=0;e<s.q.length-1;e++)t(0===s.q[e]);return t(1===s.q.leading_coeff()),d.fromCoeffs(s.p).simple_mul(1,-s.q.degree())}(s);if(o.is_zero())return d.zero;let a=d.add(d.t,d.negate(d.tinv)),l=[],h=d.unit;for(let t=0;h.minexp()>=o.minexp();t++)l.push(h),h=d.mul(h,a);let c=d.zero;for(let t=-o.minexp();t>=0&&!o.is_zero();t--)if(-o.minexp()===t){let e=l[t],r=o[0].coeff/e[0].coeff;c=c.add(d.incl(r).simple_mul(1,t)),o=o.add(d.incl(-r).mul(e))}return c}));const K=new Map;self.knot_table=K;var B={},F=[],W=[];function X(t,e,r){return"/"+t+"/"+e+"/"+r}function $(t,e,r){let i=X(t,e,r),n=B[i];return n||(n=B[i]={file:null,loaded:!1}),n}function G(t,e,r){let i=[],n=!1,s=[];for(let o=0;o<=e;o++)r.forEach((e=>{let r=$(t,o,e);r.file?r.loaded||(i.includes(r.file)||i.push(r.file),s.push(X(t,o,e))):n=!0}));return{files:i,incomplete:n,missing_entries:s}}function Y(t,e,r){let i=G(t,e,r);function n(r){let n=[];K.forEach((r=>{r.components===t&&r.crossing_number<=e&&n.push(r)})),r({knots:n,incomplete:i.incomplete})}return console.log(i),new Promise(((t,e)=>{i.files.length>0?(i.files.forEach((t=>function(t){if(!F.includes(t)){F.push(t);let e=document.createElement("script");e.src=t,e.type="text/javascript",e.async=!0,document.getElementsByTagName("head")[0].appendChild(e)}}(t))),W.push({callback:()=>n(t),keys:i.missing_entries})):n(t)}))}self.provides_knot_data=function(t,e,r,i){r.forEach((r=>{e.forEach((e=>{i.forEach((i=>{let n=$(e,r,i);n.loaded||n.file||(n.file=t)}))}))}))},self.loaded_knot_data=function(t,e,r){e.forEach((e=>{t.forEach((t=>{r.forEach((r=>{$(t,e,r).loaded=!0}))}))})),console.log("Loaded knot data crossings=%s; components=%s; properties=%s",e.join(","),t.join(","),r.join(","));var i=[];W.forEach((t=>{t.keys=t.keys.filter((t=>!B[t].loaded)),0===t.keys.length&&i.push(t.callback)})),W=W.filter((t=>t.keys.length>0)),i.forEach((t=>t()))},self.add_knot_data=function(t,e){for(let r=0;r<e.length;r+=1+t.length){let i=e[r],n=K.get(i);n||(n={name:i},K.set(i,n)),t.forEach(((t,i)=>{n[t]=e[r+i+1]}))}},self.needed_files=G,self.get_knots=Y,D("identify_link",(async function(t,e){let i=e.crossing_number(),n=await S("conway_poly",e),s=[n.minexp()].concat(n.coeffs()),o=s.slice();for(let t=1;t<o.length;t++)(o[0]+t-1)%2==1&&(o[t]=-o[t]);let a=await S("jones_poly",e),l=a?[a.minexp()].concat(a.coeffs()):[0],h=[2-l.length-l[0]].concat(l.slice(1).reverse()),c=await Y(e.num_components(),i,["conway","jones"]);return{names:c.knots.filter((t=>{let e=r(s,t.conway)&&r(l,t.jones);return e||(e=r(o,t.conway)&&r(h,t.jones)),e})).map((t=>{let e={name:t.name};return t.katlas&&(e.katlas="http://katlas.math.toronto.edu/wiki/"+t.katlas),e})),incomplete:c.incomplete}}));const J=[0,255,16711680,52224,8947848,43758,65280,15597806,15632384,16772608];let Q={tool:"crossing-change"},Z="KnotTheory",H={"linking-matrix":!0,"seifert-matrix":!1,"alexander-module":!1};function V(t,e){let r=Boolean(H[t]);e.prop("open",r),e.on("toggle",(r=>{H[t]=e.prop("open")}))}class tt{constructor(e,r,i){t(e>0),t(r>0),t(i instanceof z),this.width=e,this.height=r,this.diagram=i,this.c=new x(0,0),this.zoom=1,this.mode_name="Diagrams"}copy(){let t=new tt(this.width,this.height,this.diagram.copy());return t.c=this.c.copy(),t.zoom=this.zoom,t}mouse_to_pt(e){return t(e instanceof x),new x(this.zoom*(e.x-this.c.x),this.zoom*(e.y-this.c.y))}find_closest_crossing(t){let e=this.diagram,r=10*this.zoom,i=null;return e.verts.forEach(((n,s)=>{if(4===e.adjs[s].length){let e=x.dist(t,n);e<=r&&(r=e,i=s)}})),i}draw_crossing_disk(t,e){t.save(),t.fillStyle="#0000ff",t.globalAlpha=.2,t.beginPath(),t.arc((t=>t/this.zoom+this.c.x)(e.x)+.5,(t=>t/this.zoom+this.c.y)(e.y)+.5,10,0,2*Math.PI),t.fill(),t.restore()}find_closest_circuit(t){let e=this.diagram,r=9*this.zoom,i=null;return e.edges.forEach(((n,s)=>{let o=b(e.verts[n[0]],e.verts[n[1]],t);o<=r&&(r=o,i=s)})),null==i?null:e.dart_circuit(i+1)}highlight_circuit(t,e){let r=t=>t/this.zoom+this.c.x,i=t=>t/this.zoom+this.c.y,n=this.diagram,s=e.map((t=>n.verts[n.dart_start(t)]));t.save(),t.strokeStyle="#0000ff",t.globalAlpha=.2,t.lineWidth=9,t.beginPath(),s.forEach((e=>{t.lineTo(r(e.x)+.5,i(e.y)+.5)})),t.closePath(),t.stroke(),t.restore()}mousedown(t,e,r,i){t=this.mouse_to_pt(t);let n=Q.tool;if("crossing-change"===n){let e=this.find_closest_crossing(t);if(null!==e){let t=this.copy(),n=t.diagram.adjs[e];n.push(n.shift()),r.push(t),t.draw_crossing_disk(i,t.diagram.verts[e])}}else if("toggle-orientation"===n){let e=this.find_closest_circuit(t);if(null!==e){let t=this.copy();t.diagram.reverse_orientation(e[0]),r.push(t),t.highlight_circuit(i,e)}}else if("delete-component"===n){let e=this.find_closest_circuit(t);if(null!==e){let t=this.copy();t.diagram.delete_component(e[0]),r.push(t)}}else if(n.startsWith("set-color-")){let e=+n.slice("set-color-".length),s=this.find_closest_circuit(t);if(null!==s){let t=this.copy();s.forEach((r=>{t.diagram.dart_edge(r)[2]=e})),r.push(t),t.highlight_circuit(i,s)}}}mousemove(t,e,r,i){t=this.mouse_to_pt(t);let n=Q.tool;if("crossing-change"===n){this.paint(i);let e=this.find_closest_crossing(t);null!==e&&this.draw_crossing_disk(i,this.diagram.verts[e])}else if("toggle-orientation"===n){this.paint(i);let e=this.find_closest_circuit(t);null!==e&&this.highlight_circuit(i,e)}else if("delete-component"===n){this.paint(i);let e=this.find_closest_circuit(t);null!==e&&this.highlight_circuit(i,e)}else if(n.startsWith("set-color-")){this.paint(i);let e=this.find_closest_circuit(t);null!==e&&this.highlight_circuit(i,e)}}mouseup(t,e,r,i){t=this.mouse_to_pt(t)}mousewheel(t,e,r,i){let n=Math.sign(e.deltaY),s=this.mouse_to_pt(t);this.zoom*=Math.pow(1.05,n);let o=this.mouse_to_pt(t);this.c.x+=(o.x-s.x)/this.zoom,this.c.y+=(o.y-s.y)/this.zoom,this.paint(i)}toolbox(t){let e=this.$div=c.div(),r=this.diagram;c.create("h2").append("Modification tools").appendTo(e);let i=c.div().appendTo(e);c.span(c.span({className:"icon24-crossing"})).addClass("icon-button").prop("data-tool","crossing-change").prop("title","Change crossing type").appendTo(i),c.span(c.span({className:"icon24-two-arrows"})).addClass("icon-button").prop("data-tool","toggle-orientation").prop("title","Toggle component orientation").appendTo(i),c.span(c.span({className:"icon24-trash"})).addClass("icon-button").prop("data-tool","delete-component").prop("title","Delete component").appendTo(i),i.append(c.create("br")),J.forEach(((t,e)=>{let r=c.span().addClass("icon-button").prop("data-tool","set-color-"+(e+1)).prop("title","Recolor component to color "+(e+1)).appendTo(i);c.span(" ").addClass("icon-color").css("background",l(t)).appendTo(r)})),this.update_tool=t=>{e.query(".icon-button").forEach((e=>{let r=e.prop("data-tool");"string"==typeof r&&e.toggleClass("active",r===t)}))},this.update_tool(Q.tool),i.on("click",(t=>{let e=t.target.closest(".icon-button");if(e){let r=c(e).prop("data-tool");"string"==typeof r&&(t.preventDefault(),t.stopPropagation(),Q.tool=r,this.update_tool(r))}})),c.create("input").prop("type","button").value("Mirror").prop("title","Change the types of all crossings").appendTo(e).on("click",(e=>{let r=this.copy();r.diagram.adjs.forEach((t=>{t.push(t.shift())})),t.push(r)})),c.create("input").prop("type","button").value("Invert").prop("title","Change orientations of each component").appendTo(e).on("click",(e=>{let r=this.copy();r.diagram.edges.forEach((t=>{let e=t[0];t[0]=t[1],t[1]=e})),r.diagram.adjs=r.diagram.adjs.map((t=>t.map((t=>-t)))),t.push(r)})),c.create("input").prop("type","button").value("Make alternating").prop("title","Change types of crossings to make an alternating diagram").appendTo(e).on("click",(e=>{let r=this.copy();r.diagram.make_alternating(),t.push(r)})),e.append(c.create("input",{type:"button",title:"Assign distinct colors to each component"}).value("Auto-color").on("click",(e=>{let r=this.copy();r.diagram.auto_color(J.length),t.push(r)}))),e.append(c.create("br")),c.create("input").prop("type","button").value("Convert to drawing").prop("title","Convert the diagram back into a drawing for free-form editing (no round-trip guarantee)").appendTo(e).on("click",(e=>{let r=document.createElement("canvas");r.width=this.width,r.height=this.height;let i=r.getContext("2d");this.paint(i,!1);let n=new rt(this.width,this.height);n.fromImage(i.getImageData(0,0,this.width,this.height)),t.push(n)})),e.append(c.create("h2").append("Isotopy tools")),c.create("input").prop("type","button").value("Beautify").prop("title","Redraw using a Tutte embedding of a barycentric subdivision of the diagram").appendTo(e).on("click",(e=>{let r=this.copy();r.diagram.beautify(),t.push(r)})),e.append(c.create("hr")),e.append(c.create("h2").append("Diagram information"));let n=c.create("div").prop("id","diag-info").appendTo(e);{let t=c.create("table",{className:"diag-props"});n.append(t),t.append(c.create("tr",c.create("th","Crossings:"),c.create("td",""+this.diagram.crossing_number()))),t.append(c.create("tr",c.create("th","Components:"),c.create("td",""+this.diagram.num_components()))),t.append(c.create("tr",c.create("th","Writhe:"),c.create("td",""+this.diagram.writhe()))),t.append(c.create("tr",c.create("th","Bridges:"),c.create("td",""+this.diagram.bridge_number()))),t.append(c.create("tr",{title:"The canonical Seifert genus for this diagram"},c.create("th","Can. genus:"),c.create("td",""+this.diagram.genus())));let e=this.diagram.turaev();t.append(c.create("tr",c.create("th","Turaev genus:"),c.create("td",""+e.genus)));let i=[];r.is_alternating()&&i.push("alternating"),e.plus&&e.minus?i.push("adequate"):e.plus?i.push("plus-adequate"):e.minus&&i.push("minus-adequate"),t.append(c.create("tr",c.create("th","Properties:"),c.create("td",i.length>0?i.join(", "):c.create("em","none"))));let s=c.create("details",{title:"Pairwise linking numbers between colored components. Self linking number is writhe."},c.create("summary","Linking matrix")).appendTo(n);V("linking-matrix",s);{let t=this.diagram.linking_matrix(),e=Array.from(t.keys());e.sort(((t,e)=>t-e));let r=c.create("table").addClass("linking-matrix");e.forEach((i=>{let n=c.create("tr").appendTo(r);e.forEach((e=>{let r=c.create("td").appendTo(n);r.append(""+(t.get(i).get(e)||0)),e===i&&(r.prop("style").color="white",r.prop("style").background=l(J[e-1]))}))})),s.append(r)}}let o=c.create("details",{title:"There is one Seifert linking matrix per connected component of the diagram."},c.create("summary","Seifert form")).appendTo(n);V("seifert-matrix",o),r.seifert_form().forEach((t=>{let e=c.create("table",{className:"seifert-matrix"});t.forEach((t=>{let r=c.create("tr").appendTo(e);t.forEach((t=>{r.append(c.create("td",""+t))}))})),o.append(e)}));let a=c.create("textarea").attr("readonly",!0).addClass("code-data"),h=c.create("form",{className:"inline-form"},c.create("label",c.create("input",{type:"radio",name:"pd-type",value:"KnotTheory"}),"KnotTheory"),c.create("label",c.create("input",{type:"radio",name:"pd-type",value:"KnotTheory-oriented"}),"Oriented KnotTheory"),c.create("label",c.create("input",{type:"radio",name:"pd-type",value:"SnapPy"}),"SnapPy"));function f(t){h[0].elements["pd-type"].value=Z=t;try{"KnotTheory"===t?a.value(r.get_pd().toMathematica()):"KnotTheory-oriented"===t?a.value(r.get_pd(!0).toMathematica()):"SnapPy"===t&&a.value(r.get_pd().toSnappy())}catch(t){a.value(""+t)}}h.on("change",(function(t){f(this.elements["pd-type"].value)})),n.append(c.create("p").append("PD: ").append(h,c.create("br"),a)),f(Z);let p=r.get_dt();function u(t,e,r="t",i=1){t.then((t=>{t?e.append(t.toDOM(r,i)):e.append("n/a")}),(t=>{console.log(t),e.addClass("calc-error"),e.append("Error: "+t)}))}var g;p&&n.append(c.create("p",{title:"The Dowker-Thistlethwaite code for the knot."}).append("DT: "+s(p))),n.append(c.create("p").append("Kauffman bracket:").append(g=c.create("div"))),u(S("kauffman_bracket",this.diagram),g,"A"),n.append(c.create("h2").append("Identification"));let m=c.create("p").appendTo(n);S("identify_link",this.diagram).then((t=>{0===t.names.length?m.append("Unknown link"):(m.append("Candidates: "),t.names.forEach(((t,e)=>{e>0&&m.append(", "),t.katlas?m.append(c.create("a",{href:t.katlas,target:"_blank"},t.name)):m.append(t.name)}))),t.incomplete&&m.append(" (warning: possibly incomplete)")}),(t=>{console.error(t),m.addClass("calc-error"),m.append("Error: "+t)})),n.append(c.create("h2").append("Invariants"));{let t,e,i,s=c.create("table",{className:"diag-props"});n.append(s),s.append(c.create("tr",c.create("th","Determinant:"),t=c.create("td"))),async function(){let e=(await S("alexander_poly",r,0)).coeffs(),i=0;for(let t=0;t<e.length;t++)i+=e[t]*(t%2*2-1);t.append(""+Math.abs(i))}(),n.append(c.create("p").append("Jones polynomial:").append(e=c.create("div"))),u(S("jones_poly",this.diagram),e,"t",2),n.append(c.create("p").append("Conway potential:").append(i=c.create("div"))),u(S("conway_poly",r),i,"z");let o=c.create("p").append("Alexander polynomials:").appendTo(n);!async function(){try{for(let t=0;;t++){let e=await S("alexander_poly",r,t);if(t>=1&&e.equal(d.unit))break;o.append(c.create("br")),o.append("Δ"),o.append(c.create("sup").append(""+t)),o.append("(t) = ",e.toDOM("t"))}}catch(t){throw o.append(c.create("div",{className:"calc-error"},""+t)),t}}();let a=c.create("details",{title:"Mildly simplified (not normalized since Z[t,t^-1] is not a PID)"},c.create("summary","An Alexander module presentation matrix:")).appendTo(n);V("alexander-module",a),async function(){let t=await S("alexander_module",r),e=c.create("table").addClass("alexander-matrix");t.forEach((t=>{let r=c.create("tr").appendTo(e);t.forEach((t=>{c.create("td").appendTo(r).append(t.toDOM("t"))}))})),a.append(e),a.append(c.create("em").append("("+t.length+" generator(s))"))}()}return e}paint(t,e=!0){t.save(),t.fillStyle="white",t.fillRect(0,0,this.width,this.height);let r=t=>t/this.zoom+this.c.x,i=t=>t/this.zoom+this.c.y,n=this.diagram,s=new Set,o=o=>{if(s.has(o))return;function a(t){return t=n.opp_dart(t),4===n.dart_order(t)&&!n.dart_is_over(t)}n.dart_start(o)===n.dart_edge(o)[0]&&(o=n.opp_dart(o));let h=o;for(;!a(h)&&(h=n.through_dart(h),h!==o););let c=[],f=!1;for(h=o=n.opp_dart(h);;){if(s.add(h),s.add(n.opp_dart(h)),c.push(n.verts[n.dart_start(h)]),a(h)){c.push(n.verts[n.dart_end(h)]);break}if(c.length>1&&h===o){f=!0;break}h=n.through_dart(h)}if(!f){let t=8*this.zoom;for(;t>0&&c.length>=2;){let e=x.dist(c[0],c[1]);if(!(e<=t)){c[0]=E(c[0],c[1],t/e);break}t-=e,c.shift()}for(t=8*this.zoom;t>0&&c.length>=2;){let e=x.dist(c[c.length-2],c[c.length-1]);if(!(e<=t)){c[c.length-1]=E(c[c.length-1],c[c.length-2],t/e);break}t-=e,c.pop()}}t.beginPath(),t.moveTo(r(c[0].x)+.5,i(c[0].y)+.5);for(let e=1;e<c.length;e++){let n=c[e];t.lineTo(r(n.x)+.5,i(n.y)+.5)}if(t.strokeStyle=l(J[n.dart_edge(o)[2]-1]),t.lineWidth=3,t.lineCap="round",t.stroke(),e){let e=c[c.length-1],n=0,s=0,o=5;for(let t=c.length-2;t>=0&&o>0;t--){let e=c[t],r=c[t+1];n+=r.x-e.x,s+=r.y-e.y,o-=x.dist(e,r)}let a=Math.sqrt(n*n+s*s);if(a>0){function p(t,i){return r(e.x)+n*t-s*i+.5}function u(t,r){return i(e.y)+s*t+n*r+.5}n/=a,s/=a,t.beginPath(),t.moveTo(p(-5,2),u(-5,2)),t.lineTo(p(0,0),u(0,0)),t.lineTo(p(-5,-2),u(-5,-2)),t.stroke()}}};n.edges.forEach(((t,e)=>{o(e+1)})),t.restore()}}let et={mode:"pencil",color:1,go_over:1};class rt{constructor(e,r){t(e>0),t(r>0),this.width=e,this.height=r,this.buffer=new Int8Array(this.width*this.height),this.temp=new Int8Array(this.width*this.height),this.mode_name="Painting",this.next_knot=null}copy(){let t=new rt(this.width,this.height);return t.buffer.set(this.buffer),t}mousedown(t,e,r,i){if(0===e.button||2===e.button){if(this.next_knot)return void this.mousemove(t,e,r,i);this.next_knot=this.copy(),0===e.button?"eraser"===et.mode?this.the_color=0:this.the_color=et.color:(this.the_color=0,this.mark_tool&&this.mark_tool("eraser"));let n=et.go_over*(e.shiftKey?-1:1);this.mark_height(n),this.next_knot.draw_line(null,null,t,this.the_color,n),this.pprev=[],this.pt1=t,this.paint(i)}}mousemove(t,e,r,i){if(this.next_knot){if(x.dist(this.pt1,t)<2)return;let r=et.go_over*(e.shiftKey?-1:1);this.mark_height(r),this.next_knot.draw_line(this.pprev,this.pt1,t,this.the_color,r),this.pprev.push(this.pt1),this.pt1=t;{let t=x.dist(this.pprev[this.pprev.length-1],this.pt1);for(let e=1;e+1<this.pprev.length;e++)t+=x.dist(this.pprev[e],this.pprev[e+1]);for(;t>=7&&this.pprev.length>2;)this.pprev.shift(),t-=x.dist(this.pprev[0],this.pprev[1])}this.paint(i)}}mouseup(t,e,r,i){if(this.next_knot){this.mousemove(t,e,r,i);let n=this.next_knot;this.next_knot=null,r.push(n)}}toolbox(t){let e=this.$div=c.div();e.append(c.create("div",c.create("h2","Tools"),c.create("span",{"data-tool":"pencil",title:"Pencil",className:"icon-button"},c.create("span",{className:"icon24-pencil"})),c.create("span",{"data-tool":"eraser",title:"Eraser [right click]",className:"icon-button"},c.create("span",{className:"icon24-eraser"}))).on("click",(t=>{let e=t.target.closest(".icon-button");if(e){let r=e["data-tool"];r&&(t.preventDefault(),t.stopPropagation(),et.mode=r,this.mark_tool(r))}}))),this.mark_tool=function(t){e.query(".icon-button").forEach((e=>{let r=e.prop("data-tool");"string"==typeof r&&e.toggleClass("active",r===t)}))},this.mark_tool(et.mode),e.append(c.create("div",c.create("h2").append("Pencil mode"),c.create("span",{"data-height":1,title:"Go over",className:"icon-button"},c.create("span",{className:"icon24-go-over"})),c.create("span",{"data-height":0,title:"Go through (no auto-gaps)",className:"icon-button"},c.create("span",{className:"icon24-go-through"})),c.create("span",{"data-height":-1,title:"Go under [shift]",className:"icon-button"},c.create("span",{className:"icon24-go-under"}))).on("click",(t=>{let e=t.target.closest(".icon-button");if(e){let r=c(e).prop("data-height");"number"==typeof r&&(t.preventDefault(),t.stopPropagation(),et.go_over=r,this.mark_height(r),et.mode="pencil",this.mark_tool("pencil"))}}))),this.mark_height=function(t){e.query(".icon-button").forEach((e=>{let r=e.prop("data-height");"number"==typeof r&&e.toggleClass("active",t===r)}))},this.mark_height(et.go_over);{let t=c.div().appendTo(e);t.append(c.create("h2","Pencil colors")),J.forEach(((e,r)=>{t.append(c.create("span",{className:"icon-button","data-color":r+1,title:"Color "+(r+1)},c.create("span",{className:"icon-color"}).css("background",l(e))))})),t.on("click",(t=>{let e=t.target.closest(".icon-button");if(e){let r=c(e).prop("data-color");r&&(t.preventDefault(),t.stopPropagation(),et.color=r,this.mark_color(r),et.mode="pencil",this.mark_tool("pencil"))}}),!0),this.mark_color=function(e){t.query(".icon-button").forEach((t=>{t.toggleClass("active",t.prop("data-color")===e)}))},this.mark_color(et.color)}if(e.append(c.create("br")),e.append(c.create("label",{title:"Load an image from a file (can also drag and drop from the filesystem or sometimes copy and paste)"},"Load image: ",c.create("input",{type:"file",accept:"image/*"}).on("change",(e=>{let r=e.target.files[0];if(r){let e=new FileReader;e.readAsDataURL(r),e.onloadend=()=>{let r=document.createElement("img");r.onload=()=>{t.push(new lt(800,800,r))},r.src=e.result}}})))),e.append(c.create("hr")),e.append(c.create("input",{type:"button",title:"Find cores of curves by morphological thinning"}).value("Clean up").on("click",(e=>{let r=this.copy();r.clean_up(),t.push(r)}))),e.append(c.create("br")),e.append(c.create("input",{type:"button",title:"Clear boundary pixels of curves"}).value("Thin").on("click",(e=>{let r=this.copy();r.thin(),t.push(r)}))),e.append(c.create("input",{type:"button",title:"Add boundary pixels to curves"}).value("Thicken").on("click",(e=>{let r=this.copy();r.thicken(),t.push(r)}))),e.append(c.create("hr")),e.append(c.create("input",{type:"button",title:"Analyze picture and convert to a diagram"}).value("Convert to diagram").on("click",(e=>{t.push(this.convert())}))),this.the_error){let t=c.div({className:"error"},c.create("h2","Error")).appendTo(e);this.the_error instanceof Array?this.the_error.forEach((e=>t.append(c.p(""+e)))):t.append(c.p(""+this.the_error))}return e}paint(t){let e=t.getImageData(0,0,this.width,this.height);this.writeImage(e),t.putImageData(e,0,0)}writeImage(e){t(e.height>=this.height),t(e.width>=this.width);let r=e.data,i=this.width,n=this.height,s=this.next_knot?this.next_knot.buffer:this.buffer;for(let t=0;t<n;t++)for(let e=0;e<i;e++){let n=i*t+e,o=s[n];if(o>0){let t=J[o-1];r[4*n+0]=t>>>16&255,r[4*n+1]=t>>>8&255,r[4*n+2]=255&t,r[4*n+3]=255}else 0===o?(r[4*n+0]=255,r[4*n+1]=255,r[4*n+2]=255,r[4*n+3]=255):(r[4*n+0]=255,r[4*n+1]=150,r[4*n+2]=150,r[4*n+3]=255)}}fromImage(e){t(e.height>=this.height),t(e.width>=this.width);let r=e.data,i=this.width,n=this.height,s=this.buffer;for(let t=0;t<n;t++)for(let e=0;e<i;e++){let n=i*t+e,o=r[4*n+0]<<16|r[4*n+1]<<8|r[4*n+2],a=J.indexOf(o);s[n]=a>=0?a+1:0}}draw_line(t,e,r,i,n=1){let s=this.buffer,o=this.temp,a=0|this.width,l=0|this.height,h=(t,e)=>0<=t&&t<a&&0<=e&&e<l?s[e*a+t]:0,c=(t,e,r)=>{0<=t&&t<a&&0<=e&&e<l&&(s[e*a+t]=r)},f=(t,e)=>0<=t&&t<a&&0<=e&&e<l?o[e*a+t]:-1,p=(t,e,r)=>{0<=t&&t<a&&0<=e&&e<l&&(o[e*a+t]=r)};function u(t,e,r,i){for(let n=-r;n<=r;n++)for(let s=-r;s<=r;s++)i(t+s,e+n)}if(0===i)for(let t of M(e||r,r))u(t.x,t.y,5,((t,e)=>c(t,e,0)));else{function d(t,e,r){t<0||-1!==f(e,r)||h(e,r)!==i||(p(e,r,-2),u(e,r,1,((e,r)=>d(t-1,e,r))))}o.fill(-1),e=e||r;let a=null;if(null===t||0===t.length)a=e;else{let i=x.dist(e,r),n=e;for(let e=t.length-1;e>=0;e--)i+=x.dist(n,t[e]),n=t[e];i<=7&&(a=t[0])}if(null!==a&&u(a.x,a.y,2,((t,e)=>d(3,t,e))),null!==t){let r=e;t:for(var g=t.length-1;g>=0;g--){for(let e of M(r,t[g])){if(-1===h(e.x,e.y))break t;u(e.x,e.y,1,((t,e)=>p(t,e,-2)))}r=t[g]}}for(let t of M(e,r))n>0?(u(t.x,t.y,3,((t,e)=>{-1===f(t,e)&&p(t,e,0)})),u(t.x,t.y,1,((t,e)=>p(t,e,i)))):u(t.x,t.y,1,n<0?(t,e)=>{let r=!1;u(t,e,2,((t,e)=>{-1===f(t,e)&&h(t,e)>0&&(r=!0)})),r||p(t,e,i)}:(t,e)=>p(t,e,i));for(let t=0;t<64e4;t++){let e=o[t];e>=0&&(s[t]=e)}}}strip_errors(){let t=this.buffer;for(let e=0;e<t.length;e++)t[e]<0&&(t[e]=0)}add_error(e,r=6.5){t(e instanceof x);let i=0|this.width,n=0|this.height,s=this.buffer,o=Math.ceil(r);for(let t=-o;t<=o;t++){let a=Math.floor(e.y)+t;if(!(a<0||a>=n))for(let n=-o;n<=o;n++){let o=Math.floor(e.x)+n;o<0||o>=i||n*n+t*t<=r*r&&s[i*a+o]<=0&&(s[i*a+o]=-1)}}}thin(){let t=0|this.width,e=0|this.height,r=this.buffer,i=this.temp;i.fill(0),this.strip_errors();for(let n=0;n<e;n++)for(let s=0;s<t;s++){let o=!1,a=r[n*t+s];if(0===n||n===e-1)o=!0;else if(0===s||s===t-1)o=!0;else if(a>0)t:for(let e=-1;e<=1;e++)for(let i=-1;i<=1;i++)if(r[(n+e)*t+(s+i)]!==a){o=!0;break t}o&&(i[n*t+s]=-1)}for(let n=0;n<e;n++)for(let e=0;e<t;e++)-1===i[n*t+e]&&(r[n*t+e]=0)}thicken(){let t=0|this.width,e=0|this.height,r=this.buffer,i=this.temp;i.fill(0),this.strip_errors();for(let n=0;n<e;n++)for(let s=0;s<t;s++){if(r[n*t+s]>0)continue;let o=0;t:for(let i=n-1;i<=n+1;i++)if(!(i<0||i>=e))for(let e=s-1;e<=s+1;e++)if(!(e<0||e>=t)&&(o=r[i*t+e],o>0))break t;i[n*t+s]=o}for(let n=0;n<e;n++)for(let e=0;e<t;e++){let s=i[n*t+e];s>0&&(r[n*t+e]=s)}}clean_up(){let t=0|this.width,e=0|this.height,r=this.buffer,i=this.temp;this.strip_errors();for(let i=0;i<t;i++)r[0*t+i]=0,r[t*(e-1)+i]=0;for(let i=0;i<e;i++)r[t*i+0]=0,r[t*i+t-1]=0;let n=new Int8Array(9);function s(i,s){let o=!1;for(let l=1;l<=e-2;l++)for(let e=1;e<=t-2;e++){let h=r[t*l+e];if(h<=0)continue;for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++)r[t*(l+i)+(e+s)]===h?n[3*(i+1)+(s+1)]=1:n[3*(i+1)+(s+1)]=0;n[1]&&(n[3]&&(n[0]=1),n[5]&&(n[2]=1)),n[7]&&(n[3]&&(n[6]=1),n[5]&&(n[8]=1));let c=n[5],f=0,p=0;function a(t,e){let r=n[3*(1+e)+(1+t)];r!==c&&(p++,c=r),r>0&&f++}a(1,1),a(0,1),a(-1,1),a(-1,0),a(-1,-1),a(0,-1),a(1,-1),a(1,0),0===f?r[t*l+e]=0:2===p&&i<=f&&f<=s&&(r[t*l+e]=0,o=!0)}return o}let o=!0;for(;o;)o=s(3,4),o||(o=s(2,6));i.fill(0);for(let n=1;n<=e-2;n++)for(let e=1;e<=t-2;e++){let s=r[t*n+e];if(s>0){let o=-1;for(let i=-1;i<=1;i++)for(let a=-1;a<=1;a++)r[t*(n+i)+(e+a)]===s&&o++;1===o&&(i[t*n+e]=1)}}for(let n=1;n<=e-2;n++)for(let e=1;e<=t-2;e++)i[t*n+e]>0&&(r[t*n+e]=0)}convert(){let e=this.copy();e.clean_up();let r=0|e.width,i=0|e.height,n=e.buffer;function s(t,e){let i=n[e*r+t],s=-1;for(let o=-1;o<=1;o++)for(let a=-1;a<=1;a++)n[(e+o)*r+(t+a)]===i&&s++;return s}function o(t,e,i){if(i<=0)return!1;let a=s(t,e);if(0===a)return!1;if(1===a){let s=n[e*r+t];for(let a=-1;a<=1;a++)for(let l=-1;l<=1;l++)if((0!==l||0!==a)&&n[(e+a)*r+(t+l)]===s){return n[e*r+t]=0,!!o(t+l,e+a,i-1)||(n[e*r+t]=s,!1)}throw new Error("Cannot get here.")}return!0}for(let t=1;t<=i-2;t++)for(let e=1;e<=r-2;e++)n[t*r+e]>0&&1===s(e,t)&&o(e,t,5);for(let t=1;t<=i-2;t++)for(let e=1;e<=r-2;e++)n[t*r+e]>0&&0===s(e,t)&&(n[t*r+e]=0);let a=!1;for(let t=1;t<=i-2;t++)for(let i=1;i<=r-2;i++)n[t*r+i]>0&&s(i,t)>2&&(e.add_error(new x(i,t)),a=!0);if(a)return e.the_error="The marked junctions cannot be interpreted. Usually this is because one of the understrands has fused to the overstrand, which can be fixed with a little erasing.",e;let l=e.copy();l.thicken();let h=new Map;for(let t=1;t<=i-2;t++)for(let e=1;e<=r-2;e++){let i=n[t*r+e];if(i>0&&1===s(e,t)){let r=h.get(i);r||(r=[],h.set(i,r)),r.push(new x(e,t))}}let c=[],f=[];function p(){return console.log("error"),e.the_error=f,e}if(h.forEach(((t,i)=>{let n=null;if(n=function(t,e){let i=new Array(t.length);for(let e=0;e<t.length;e++)(i[e]=new Array(t.length)).fill(1/0);let n=[];for(let e=0;e<t.length;e++){let s=t[e];for(let o=e+1;o<t.length;o++){let a=t[o],h=x.dist(s,a),c=0,f=-2;for(let t of M(s,a)){let e=l.buffer[r*t.y+t.x];0===e&&(e=0|l.buffer[r*t.y+(t.x+1)]),0===e&&(e=0|l.buffer[r*(t.y+1)+t.x]),e!==f&&(e>0&&c++,f=e)}if(c>1){let t=Math.min(2,c-1),r=(h-3*t)/t;r=Math.max(0,r),i[e][o]=r,i[o][e]=r,n.push([e,o,r])}}}n.sort(((t,e)=>t[2]-e[2]));let s=Array(t.length).fill(!1),o=[];if(n.forEach((t=>{s[t[0]]||s[t[1]]||(o.push([t[0],t[1]]),s[t[0]]=!0,s[t[1]]=!0)})),2*o.length<t.length){let e=[];for(let r=0;r<s.length;r++)s[r]||e.push(t[r]);return{err_points:e}}let a=0,h=!0;for(;h;){h=!1;for(let t=0;t<o.length;t++)for(let e=t+1;e<o.length;e++){let[r,n]=o[t],[s,l]=o[e],c=i[r][n]+i[s][l],f=i[r][s]+i[n][l],p=i[r][l]+i[s][n];f<c&&f<=p?(o[t][1]=s,o[e][0]=n,h=!0,a++):p<c&&p<=f&&(o[t][1]=l,o[e][1]=n,h=!0,a++)}}return console.log("swaps= "+a),o.map((e=>[t[e[0]],t[e[1]]]))}(t),n.err_points)return a=!0,n.err_points.forEach((t=>e.add_error(t))),void f.push("Couldn't find a way to match up endpoints in the component of color "+i+".  The unmatched points have been marked.");n.forEach((t=>{c.forEach((r=>{let i=k(r[0],r[1],t[0],t[1]);i&&(a=!0,e.add_error(i),f.push("There was a pair of matched-up endpoints whose matchings intersect.  The intersection point has been marked."))})),c.push([t[0],t[1],i])}))})),a)return p();n=new Int8Array(n);let u=[],d=[];function g(t){for(let e=0;e<u.length;e++)if(x.equal(u[e],t))return e;throw new Error("point not found")}function m(t,e,i){let o=u.length;u.push(new x(e,i));let a=null;2===s(e,i)&&(a=o);t:for(;n[i*r+e]===t;){n[i*r+e]=0;for(let s=-1;s<=1;s++)for(let a=-1;a<=1;a++)if(t===n[(i+s)*r+(e+a)]){for(e+=a,i+=s;t===n[(i+s)*r+(e+a)];)n[i*r+e]=0,e+=a,i+=s;let l=u.length;u.push(new x(e,i)),d.push([o,l,t,!0]),o=l;continue t}null!==a&&d.push([o,a,t,!0])}}for(let t=1;t<=i-2;t++)for(let e=1;e<=r-2;e++){let i=n[t*r+e];i>0&&1===s(e,t)&&m(i,e,t)}for(let t=1;t<=i-2;t++)for(let e=1;e<=r-2;e++){let i=n[t*r+e];i>0&&m(i,e,t)}c.forEach((t=>{let e=[g(t[0]),g(t[1])];u.forEach(((t,r)=>{for(let i=0;i+1<e.length;i++){if(e[i]===r||e[i+1]===r)return;if(w(u[e[i]],u[e[i+1]],t,.01))return void e.splice(i+1,0,r)}}));var r=[];d.forEach(((t,i)=>{for(let i=0;i+1<e.length;i++){let s=k(u[t[0]],u[t[1]],u[e[i]],u[e[i+1]],.01);if(null!==s){let o=null;function n(){return null===o&&(o=u.length,u.push(s)),o}return x.similar(s,u[t[0]],.01)||x.similar(s,u[t[1]],.01)||(r.push([n(),t[1],t[2],!0]),t[1]=n()),void(x.similar(s,u[e[i]],.01)||x.similar(s,u[e[i+1]],.01)||e.splice(i+1,0,n()))}}})),r.forEach((t=>d.push(t)));for(let r=0;r+1<e.length;r++)d.push([e[r],e[r+1],t[2],!1])}));let _=[];for(let t=0;t<u.length;t++)_[t]=[];d.forEach(((t,e)=>{_[t[0]].push(e+1),_[t[1]].push(-e-1)}));let y=new z(u,d,_);return _.forEach(((r,i)=>{if(2===r.length){let e=y.dart_edge(r[0]),i=y.dart_edge(r[1]);return void t(e[2]===i[2])}t(4===r.length);let n=u[i],s=r.map((t=>y.dart_end(t))).map((t=>-function(t,e){let r=e.x-t.x,i=e.y-t.y,n=r/(Math.abs(r)+Math.abs(i));return(i>=0?1-n:3+n)/4}(n,u[t])));function o(t,e){if(s[t]>s[e]){let i=s[t];s[t]=s[e],s[e]=i;let n=r[t];r[t]=r[e],r[e]=n}}o(1,3),o(0,2),o(0,1),o(2,3),o(1,2);for(let t=0;t<3;t++)if(Math.abs((s[t]-s[t+1]+Math.PI)%(2*Math.PI)-Math.PI)<1e-6)return a=!0,e.add_error(n),void f.push("The edges around the marked vertex were unexpectly coincident.  (This error has never been observed before!)");y.dart_edge(r[0])[3]&&r.push(r.shift());let l=y.dart_edge(r[0]),h=y.dart_edge(r[1]),c=y.dart_edge(r[2]),p=y.dart_edge(r[3]);if(l[3]||!h[3]||c[3]||!p[3]||l[2]!==c[2]||h[2]!==p[2])return a=!0,e.add_error(n),void f.push("The marked crossing is not transverse.")})),a?p():(y.ensure_orientation(),new tt(this.width,this.height,y))}}var it=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],nt=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function st(t,e,r,i){if(!(isNaN(i)||i<1)){var n,s,o,a,l,h,c,f,p,u,d,g,m,_,y,v,x,w,b,k,E=(i|=0)+i+1,M=e-1,z=r-1,T=i+1,j=T*(T+1)/2,C=new ot,q=C;for(o=1;o<E;o++)if(q=q.next=new ot,o==T)var A=q;q.next=C;var P=null,S=null;c=h=0;var D=it[i],N=nt[i];for(s=0;s<r;s++){for(_=y=v=f=p=u=0,d=T*(x=t[h]),g=T*(w=t[h+1]),m=T*(b=t[h+2]),f+=j*x,p+=j*w,u+=j*b,q=C,o=0;o<T;o++)q.r=x,q.g=w,q.b=b,q=q.next;for(o=1;o<T;o++)a=h+((M<o?M:o)<<2),f+=(q.r=x=t[a])*(k=T-o),p+=(q.g=w=t[a+1])*k,u+=(q.b=b=t[a+2])*k,_+=x,y+=w,v+=b,q=q.next;for(P=C,S=A,n=0;n<e;n++)t[h]=f*D>>N,t[h+1]=p*D>>N,t[h+2]=u*D>>N,f-=d,p-=g,u-=m,d-=P.r,g-=P.g,m-=P.b,a=c+((a=n+i+1)<M?a:M)<<2,f+=_+=P.r=t[a],p+=y+=P.g=t[a+1],u+=v+=P.b=t[a+2],P=P.next,d+=x=S.r,g+=w=S.g,m+=b=S.b,_-=x,y-=w,v-=b,S=S.next,h+=4;c+=e}for(n=0;n<e;n++){for(y=v=_=p=u=f=0,d=T*(x=t[h=n<<2]),g=T*(w=t[h+1]),m=T*(b=t[h+2]),f+=j*x,p+=j*w,u+=j*b,q=C,o=0;o<T;o++)q.r=x,q.g=w,q.b=b,q=q.next;for(l=e,o=1;o<=i;o++)h=l+n<<2,f+=(q.r=x=t[h])*(k=T-o),p+=(q.g=w=t[h+1])*k,u+=(q.b=b=t[h+2])*k,_+=x,y+=w,v+=b,q=q.next,o<z&&(l+=e);for(h=n,P=C,S=A,s=0;s<r;s++)t[a=h<<2]=f*D>>N,t[a+1]=p*D>>N,t[a+2]=u*D>>N,f-=d,p-=g,u-=m,d-=P.r,g-=P.g,m-=P.b,a=n+((a=s+T)<z?a:z)*e<<2,f+=_+=P.r=t[a],p+=y+=P.g=t[a+1],u+=v+=P.b=t[a+2],P=P.next,d+=x=S.r,g+=w=S.g,m+=b=S.b,_-=x,y-=w,v-=b,S=S.next,h+=e}}}function ot(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}let at={tool:"crop"};class lt{constructor(t,e,r){this.img=r,this.width=t,this.height=e,this.x=0,this.y=0,this.scale=Math.min(1,Math.min(t/r.width,e/r.height)),this.sx=0,this.sy=0,this.swidth=r.width,this.sheight=r.height,this.invert=!1,this.blur=0,this.adaptive=20,this.threshold=-.05,this.tmp_canvas=document.createElement("canvas"),this.tmp_canvas.width=this.width,this.tmp_canvas.height=this.height,this.tmp_ctxt=this.tmp_canvas.getContext("2d"),this.mode_name="Image importing"}copy(){let t=new lt(this.width,this.height,this.img);return t.x=this.x,t.y=this.y,t.scale=this.scale,t.sx=this.sx,t.sy=this.sy,t.swidth=this.swidth,t.sheight=this.sheight,t.invert=this.invert,t.blur=this.blur,t.threshold=this.threshold,t}update_crop(t,e){let r=a(Math.min(t.x-this.x,e.x-this.x)/this.scale,0,this.img.width),i=a(Math.max(t.x-this.x,e.x-this.x)/this.scale,0,this.img.width),n=a(Math.min(t.y-this.y,e.y-this.y)/this.scale,0,this.img.height),s=a(Math.max(t.y-this.y,e.y-this.y)/this.scale,0,this.img.height);this.sx=r,this.sy=n,this.swidth=i-r,this.sheight=s-n}mousedown(t,e,r,i){let n=at.tool;2===e.button&&(n="move",this.update_tool&&this.update_tool(n)),"crop"===n?(this.crop_start=t,this.update_crop(this.crop_start,t),this.paint(i)):"move"===n&&(this.move_start=t)}mousemove(t,e,r,i){e.buttons?this.crop_start?(this.update_crop(this.crop_start,t),this.paint(i)):this.move_start&&(this.x+=t.x-this.move_start.x,this.y+=t.y-this.move_start.y,this.move_start=t,this.paint(i)):this.mouseup(t,e,r,i)}mouseup(t,e,r,i){this.crop_start?(this.update_crop(this.crop_start,t),this.crop_start=null,this.paint(i)):this.move_start&&(this.move_start=null,this.paint(i)),this.update_tool(at.tool)}mouse_to_pt(e){return t(e instanceof x),new x((e.x-this.x)/this.scale,(e.y-this.y)/this.scale)}mousewheel(t,e,r,i){let n=Math.sign(e.deltaY),s=this.mouse_to_pt(t);this.set_scale(this.scale*Math.pow(1.05,-n));let o=this.mouse_to_pt(t);this.x+=this.scale*(o.x-s.x),this.y+=this.scale*(o.y-s.y),this.paint(i)}toolbox(t,e){let r=this.$div=c.div();var i;return r.append(c.div(c.span({"data-tool":"move",title:"Move image [right click]",className:"icon-button"},c.create("span",{className:"icon24-move"})),c.span({"data-tool":"crop",title:"Crop image",className:"icon-button"},c.create("span",{className:"icon24-crop"}))).on("click",(t=>{let e=t.target.closest(".icon-button");if(e){let r=c(e).prop("data-tool");"string"==typeof r&&(t.preventDefault(),t.stopPropagation(),at.tool=r,this.update_tool(r))}}))),this.update_tool=t=>{r.query(".icon-button").forEach((e=>{let r=e.prop("data-tool");"string"==typeof r&&e.toggleClass("active",r===t)}))},this.update_tool(at.tool),r.append(c.create("label",{title:"Rescale the image [mouse wheel]"},"Scale: ",i=c.create("input",{type:"range",min:"1",max:"300",step:"1",className:"slider"}))),i.on("input",(t=>{this.set_scale(t.target.value/100),this.paint(e)})),this.set_scale=t=>{t=a(t,.01,3),i.value(Math.floor(100*this.scale)),this.scale=t},this.set_scale(this.scale),r.append(c.create("br")),r.append(c.create("label",{title:"Invert the values of all the colors, for example if this is a chalk drawing."},"Invert colors: ",c.create("input",{type:"checkbox"}).on("input",(t=>{this.invert=t.target.checked,this.paint(e)})))),r.append(c.create("br")),r.append(c.create("label",{title:"Blur radius"},"Blur: ",c.create("input",{type:"range",min:"0",max:"10",step:"1",className:"slider"}).value(this.blur).on("input",(t=>{this.blur=t.target.value,this.paint(e)})))),r.append(c.create("br")),r.append(c.create("label",{title:"Adaptive radius"},"Adaptive radius: ",c.create("input",{type:"range",min:"1",max:"40",step:"1",className:"slider"}).value(this.adaptive).on("input",(t=>{this.adaptive=t.target.value,this.paint(e)})))),r.append(c.create("br")),r.append(c.create("label",{title:"Threshold for black"},"Threshold: ",c.create("input",{type:"range",min:"-500",max:"500",step:"1",className:"slider"}).value(Math.floor(1e3*this.threshold)).on("input",(t=>{this.threshold=t.target.value/1e3,this.paint(e)})))),r.append(c.create("br")),r.append(c.create("input",{type:"button",value:"Accept",title:"Take selection to painting mode"}).on("click",(r=>{this.paint(e,!0);let i=new rt(this.width,this.height);i.fromImage(e.getImageData(0,0,this.width,this.height)),t.push(i)}))),r}paint(t,e=!1){t.save(),t.fillStyle=e?"#fff":"#ddd",t.fillRect(0,0,this.width,this.height);let r=this.sx*this.scale+this.x,i=this.sy*this.scale+this.y,n=this.swidth*this.scale,s=this.sheight*this.scale,o=this.sx,a=this.sy,l=this.swidth,h=this.sheight;r<0&&(l+=r/this.scale,o=(0-this.x)/this.scale,n+=r,r=0),n>this.width&&(l-=(n-this.width)/this.scale,n=this.width),i<0&&(h+=i/this.scale,a=(0-this.y)/this.scale,s+=i,i=0),s>this.height&&(h-=(s-this.height)/this.scale,s=this.height),e||(t.globalAlpha=.3,t.drawImage(this.img,0,0,this.img.width,this.img.height,this.x,this.y,this.scale*this.img.width,this.scale*this.img.height),t.globalAlpha=1,t.fillStyle="#fff",t.fillRect(r,i,n,s));let c=this.tmp_ctxt;c.fillStyle="#fff",c.fillRect(0,0,n+1,s+1),c.drawImage(this.img,o,a,l,h,0,0,n,s);let f=c.getImageData(0,0,Math.max(1,Math.floor(n)),Math.max(1,Math.floor(s))),p=f.data,u=f.width,d=f.height;st(p,u,d,this.blur);let g=new Uint8Array(u*d),m=this.invert;for(let t=0;t<g.length;t++){let e=(p[4*t]+p[4*t+1]+p[4*t+2])/3;m&&(e=255-e),g[t]=e}st(p,u,d,this.adaptive);for(let t=0;t<g.length;t++){let e=(p[4*t]+p[4*t+1]+p[4*t+2])/3,r=g[t]-e;r=r/255<=this.threshold?0:255,g[t]=r}for(let t=0;t<g.length;t++){let e=g[t];p[4*t]=p[4*t+1]=p[4*t+2]=e,p[4*t+3]=255}t.putImageData(f,r,i),t.restore()}}class ht{constructor(){this.versions=[],this.i=-1,this.length=0,this.listeners=[]}_notify(){this.listeners.map((t=>t(this)))}get(){return t(0<=this.i&&this.i<this.length),this.versions[this.i]}push(t){this.versions.length=this.i+1,this.versions.push(t),this.i=this.versions.length-1,this.length=this.versions.length,this._notify()}undo(){this.i>0&&(this.i--,this._notify())}redo(){this.i+1<this.versions.length&&(this.i++,this._notify())}}c((function(){window.addEventListener("error",(function(t){let e=c.create("input",{type:"button",className:"program-error-close"}).value("X"),r=c.create("div",{className:"program-error"},e,c.create("h1","Unhandled error"),c.create("p","Message: "+t.message),c.create("p","in "+t.filename+":"+t.lineno+":"+t.colno),c.create("p","Error object: "+JSON.stringify(t.error)));c("body").append(r),e.on("click",(t=>r.remove()))}));var t=new ht;t.listeners.push((t=>{c(".undo-state").empty().append(`${t.i+1}/${t.length}`),c("input.undo").prop("disabled",t.i<=0),c("input.redo").prop("disabled",t.i+1>=t.length)})),c("input.undo").on("click",(()=>{t.undo()})),c("input.redo").on("click",(()=>{t.redo()}));var e=c.create("canvas").appendTo(c("#editor"));e.prop("width",800),e.prop("height",800);var r=e[0].getContext("2d");function i(t){let r=e[0].getBoundingClientRect();return new x(Math.floor(t.clientX-r.left-1),Math.floor(t.clientY-r.top-1))}function n(){t.push(new lt(800,800,this))}function s(t){c("#drop-area").css("display",t?"block":"none")}t.listeners.push((t=>{c(".modename").empty().append(t.get().mode_name),t.get().paint(r),c("#tools").empty().append(t.get().toolbox(t,r))})),t.push(new rt(800,800)),e.on("mousedown",(function(e){e.preventDefault(),e.stopPropagation(),t.get().mousedown(i(e),e,t,r)})),e.on("mousemove",(function(e){e.preventDefault(),e.stopPropagation(),t.get().mousemove(i(e),e,t,r)})),e.on("mouseup",(function(e){e.preventDefault(),e.stopPropagation(),t.get().mouseup(i(e),e,t,r)})),e.on("contextmenu",(function(t){t.preventDefault()})),e.on("wheel",(function(e){e.preventDefault(),e.stopPropagation();let n=t.get();n.mousewheel&&n.mousewheel(i(e),e,t,r)})),e.on("touchstart",(function(e){e.touches.length>1||(e.preventDefault(),e.stopPropagation(),e.button=0,e.buttons=1,t.get().mousedown(i(e.changedTouches[0]),e,t,r))})),e.on("touchmove",(function(e){e.touches.length>1||(e.preventDefault(),e.stopPropagation(),e.button=0,e.buttons=1,t.get().mousemove(i(e.changedTouches[0]),e,t,r))})),e.on("touchend",(function(e){e.touches.length>0||(e.preventDefault(),e.stopPropagation(),e.button=0,e.buttons=0,t.get().mouseup(i(e.changedTouches[0]),e,t,r))}));let o=0;document.addEventListener("dragenter",(t=>{t.preventDefault(),t.stopPropagation(),o++,s(o>0)}),!0),document.addEventListener("dragleave",(t=>{t.preventDefault(),t.stopPropagation(),o--,s(o>0)}),!0),document.addEventListener("dragover",(t=>{t.preventDefault(),t.stopPropagation(),s(!0)}),!0),document.addEventListener("drop",(t=>{t.preventDefault(),t.stopPropagation(),o=0,s(!1);let e=t.dataTransfer.getData("text/uri-list");if(e){let t=e.split("\n");for(let e=0;e<t.length;e++)if("#"!==t[e][0]){let r=document.createElement("img");return r.crossOrigin="Anonymous",r.onload=n,void(r.src=t[e])}}let r=t.dataTransfer.files;if(r.length>0){let t=r[0],e=new FileReader;return e.readAsDataURL(t),void(e.onloadend=()=>{let t=document.createElement("img");t.onload=n,t.src=e.result})}}),!0),document.addEventListener("paste",(t=>{let e=(t.clipboardData||t.originalEvent.clipboardData).items;for(let t=0;t<e.length;t++)if(e[t].type.startsWith("image/")){let r=e[t].getAsFile(),i=new FileReader;return i.readAsDataURL(r),void(i.onloadend=()=>{let t=document.createElement("img");t.onload=n,t.src=i.result})}}),!1)}));
//# sourceMappingURL=main.js.map
